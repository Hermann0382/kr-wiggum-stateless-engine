{
  "artifact_type": "flow",
  "status": "complete",
  "validation": "passed",
  "approval_required": true,
  "approvers": [
    "Cynthia",
    "Hassan"
  ],
  "next_phase": "erd_design",
  "data": {
    "project_name": "KR-Wiggum Stateless Engine",
    "version": "2026.1.0",
    "created_at": "2026-01-11T21:51:22.045Z",
    "user_flows": [
      {
        "id": "FLOW-001",
        "name": "Brainstorm Intake and PRD Generation",
        "description": "Converts raw brainstorms, transcripts, and chat logs into structured PRD, ARCHITECTURE, and ROADMAP artifacts through the Distiller component.",
        "feature_id": "FR-001",
        "story_ids": [
          "ST-001",
          "ST-002",
          "ST-003",
          "ST-004"
        ],
        "actor": "user",
        "trigger": "User executes /...seed @file command with raw brainstorm file",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "User pastes raw transcript/chat log into .agent/01_raw_brainstorm.txt",
            "actor": "user",
            "inputs": [
              "raw_transcript",
              "chat_logs",
              "interview_notes"
            ],
            "outputs": [
              "01_raw_brainstorm.txt"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "User executes /...seed @.agent/01_raw_brainstorm.txt command",
            "actor": "user",
            "inputs": [
              "slash_command",
              "file_reference"
            ],
            "outputs": [
              "distiller_trigger"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Distiller reads brainstorm file and performs voice separation analysis",
            "actor": "system",
            "inputs": [
              "01_raw_brainstorm.txt"
            ],
            "outputs": [
              "voice_of_client_data",
              "voice_of_engineer_data"
            ],
            "conditions": [
              "file_size < 50KB",
              "file_exists"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Distiller executes minimum 15 RipGrep searches to identify existing patterns",
            "actor": "system",
            "inputs": [
              "codebase",
              "existing_specs"
            ],
            "outputs": [
              "pattern_analysis",
              "keyword_map"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "System filters conversational noise and extracts core requirements",
            "actor": "system",
            "inputs": [
              "voice_of_client_data",
              "pattern_analysis"
            ],
            "outputs": [
              "functional_requirements",
              "constraints"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Distiller generates specs/PRD.md with User Stories, Business Logic, Success Criteria",
            "actor": "system",
            "inputs": [
              "functional_requirements",
              "constraints"
            ],
            "outputs": [
              "specs/PRD.md"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Distiller generates specs/index.md (PIN) with keyword-rich index for RipGrep",
            "actor": "system",
            "inputs": [
              "specs/PRD.md",
              "keyword_map"
            ],
            "outputs": [
              "specs/index.md"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Distiller breaks implementation into atomic tasks (15-30 min each, 3-5 files, <150 LOC)",
            "actor": "system",
            "inputs": [
              "specs/PRD.md",
              "dependency_analysis"
            ],
            "outputs": [
              "task_breakdown"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "System orders tasks by dependency: DB Schema -> Types -> Services -> API -> UI",
            "actor": "system",
            "inputs": [
              "task_breakdown"
            ],
            "outputs": [
              "ordered_tasks"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Distiller generates IMPLEMENTATION_PLAN.md with checkbox-based task list",
            "actor": "system",
            "inputs": [
              "ordered_tasks"
            ],
            "outputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "System confirms successful generation and displays summary to user",
            "actor": "system",
            "inputs": [
              "specs/PRD.md",
              "specs/index.md",
              "IMPLEMENTATION_PLAN.md"
            ],
            "outputs": [
              "success_status",
              "task_count"
            ],
            "conditions": [
              "processing_time < 60s"
            ],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "specs/PRD.md generated with complete User Stories and Success Criteria",
          "specs/index.md generated with keyword-rich content for RipGrep",
          "IMPLEMENTATION_PLAN.md created with ordered, atomic tasks",
          "Processing completes within 60 seconds for files under 50KB",
          "Each task references relevant KreativReason guide"
        ],
        "error_handling": [
          {
            "error_condition": "Brainstorm file not found",
            "recovery_action": "Display error message with expected file path",
            "escalation": "Prompt user to create file at .agent/01_raw_brainstorm.txt"
          },
          {
            "error_condition": "File exceeds 50KB limit",
            "recovery_action": "Warn user and suggest splitting the file",
            "escalation": "Process in chunks if user confirms"
          },
          {
            "error_condition": "RipGrep pattern search fails",
            "recovery_action": "Log error and continue with available patterns",
            "escalation": "Alert user if <5 patterns found"
          },
          {
            "error_condition": "Processing timeout (>60s)",
            "recovery_action": "Save partial progress and notify user",
            "escalation": "Allow retry or manual intervention"
          }
        ]
      },
      {
        "id": "FLOW-002",
        "name": "Shift Manager Context Monitoring",
        "description": "The Shift Manager monitors its own token usage and triggers rotation before entering the Dumb Zone (>60% context) to prevent cognitive decay.",
        "feature_id": "FR-002",
        "story_ids": [
          "ST-005"
        ],
        "actor": "system",
        "trigger": "Shift Manager instance starts or completes a Worker supervision cycle",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Shift Manager calculates current context fill percentage",
            "actor": "system",
            "inputs": [
              "total_tokens_used",
              "context_window_size"
            ],
            "outputs": [
              "context_fill_percent"
            ],
            "conditions": [
              "context_window_size = 200000"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "System evaluates context health against threshold zones",
            "actor": "system",
            "inputs": [
              "context_fill_percent"
            ],
            "outputs": [
              "zone_status"
            ],
            "conditions": [
              "Smart Zone: <40%",
              "Degrading Zone: 40-60%",
              "Dumb Zone: >60%"
            ],
            "next_steps": [
              "STEP-003",
              "STEP-004"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "If context < 60%: Continue normal operations and supervise Workers",
            "actor": "system",
            "inputs": [
              "zone_status"
            ],
            "outputs": [
              "continue_signal"
            ],
            "conditions": [
              "context_fill_percent < 60"
            ],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "If context >= 60%: Initiate shift rotation protocol",
            "actor": "system",
            "inputs": [
              "zone_status"
            ],
            "outputs": [
              "rotation_trigger"
            ],
            "conditions": [
              "context_fill_percent >= 60"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Manager writes SHIFT_HANDOFF.md with Accomplishments, Architecture Delta, Blockers",
            "actor": "system",
            "inputs": [
              "session_history",
              "adr_entries",
              "current_roadmap_position"
            ],
            "outputs": [
              "SHIFT_HANDOFF.md"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Manager exits with code 10 to signal rotation to Orchestrator",
            "actor": "system",
            "inputs": [
              "SHIFT_HANDOFF.md"
            ],
            "outputs": [
              "exit_code_10"
            ],
            "conditions": [],
            "next_steps": []
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Manager updates telemetry.json with current context percentage",
            "actor": "system",
            "inputs": [
              "context_fill_percent",
              "zone_status"
            ],
            "outputs": [
              ".ralph/telemetry.json"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Check if roadmap is 100% complete",
            "actor": "system",
            "inputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "outputs": [
              "completion_status"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-009",
              "STEP-010"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "If roadmap complete: Exit with code 0 to signal project completion",
            "actor": "system",
            "inputs": [
              "completion_status"
            ],
            "outputs": [
              "exit_code_0"
            ],
            "conditions": [
              "all_tasks_checked"
            ],
            "next_steps": []
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "If roadmap incomplete: Return to Worker supervision cycle",
            "actor": "system",
            "inputs": [
              "completion_status"
            ],
            "outputs": [
              "continue_loop"
            ],
            "conditions": [
              "unchecked_tasks_remain"
            ],
            "next_steps": [
              "STEP-001"
            ]
          }
        ],
        "success_criteria": [
          "Context fill percentage calculated accurately as (total_tokens / 200000) * 100",
          "Rotation triggered when context exceeds 60% threshold",
          "SHIFT_HANDOFF.md written before termination with complete context",
          "Exit code 10 used for rotation, exit code 0 for completion",
          "Telemetry updated in real-time for dashboard visibility"
        ],
        "error_handling": [
          {
            "error_condition": "Token count unavailable",
            "recovery_action": "Estimate based on message length and continue",
            "escalation": "Log warning and set conservative rotation threshold at 50%"
          },
          {
            "error_condition": "SHIFT_HANDOFF.md write fails",
            "recovery_action": "Retry write operation up to 3 times",
            "escalation": "Exit with error code and log failure"
          },
          {
            "error_condition": "Telemetry file locked",
            "recovery_action": "Wait 100ms and retry",
            "escalation": "Skip telemetry update and log warning"
          }
        ]
      },
      {
        "id": "FLOW-003",
        "name": "Worker Task Assignment",
        "description": "Shift Manager assigns atomic tasks to Workers with minimal context injection to keep them in the Smart Zone.",
        "feature_id": "FR-002",
        "story_ids": [
          "ST-006"
        ],
        "actor": "system",
        "trigger": "Shift Manager completes context check and has capacity for Worker supervision",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Manager reads IMPLEMENTATION_PLAN.md to find next unchecked task",
            "actor": "system",
            "inputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "outputs": [
              "next_task",
              "task_id"
            ],
            "conditions": [
              "unchecked_tasks_exist"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Manager extracts task details: Mission, Files, Verification Command",
            "actor": "system",
            "inputs": [
              "next_task"
            ],
            "outputs": [
              "task_mission",
              "target_files",
              "verify_command"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Manager prepares minimal context injection package",
            "actor": "system",
            "inputs": [
              "task_mission",
              "specs/PRD.md_reference",
              "guardrails_paths"
            ],
            "outputs": [
              "context_package"
            ],
            "conditions": [
              "package_size < 10% context"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Manager writes current_task.md with atomic task specification",
            "actor": "system",
            "inputs": [
              "context_package"
            ],
            "outputs": [
              ".agent/current_task.md"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Manager signals Orchestrator to spawn new Worker instance",
            "actor": "system",
            "inputs": [
              "spawn_request"
            ],
            "outputs": [
              "worker_spawn_signal"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Manager monitors Worker terminal output without intervention",
            "actor": "system",
            "inputs": [
              "worker_stdout",
              "worker_stderr"
            ],
            "outputs": [
              "observation_log"
            ],
            "conditions": [
              "no_direct_intervention"
            ],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Manager waits for Worker completion signal",
            "actor": "system",
            "inputs": [
              "worker_exit_code"
            ],
            "outputs": [
              "task_result"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-008",
              "STEP-009"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "If Worker succeeded (exit 0): Mark task complete in IMPLEMENTATION_PLAN.md",
            "actor": "system",
            "inputs": [
              "task_result"
            ],
            "outputs": [
              "updated_plan"
            ],
            "conditions": [
              "exit_code = 0"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "If Worker failed: Log failure and prepare retry or escalation",
            "actor": "system",
            "inputs": [
              "task_result",
              "error_details"
            ],
            "outputs": [
              "failure_log",
              "retry_decision"
            ],
            "conditions": [
              "exit_code != 0"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Manager reads Worker Status Fragment for ADR logging",
            "actor": "system",
            "inputs": [
              ".agent/status_fragment.md"
            ],
            "outputs": [
              "worker_decisions",
              "changes_summary"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "Next unchecked task selected from IMPLEMENTATION_PLAN.md",
          "Worker receives only: Mission, Guardrails paths, Back Pressure requirement",
          "No raw code injected into Worker context",
          "Manager observes but does not intervene in Worker execution",
          "Task marked complete upon successful Worker termination"
        ],
        "error_handling": [
          {
            "error_condition": "No unchecked tasks found",
            "recovery_action": "Signal project completion to Orchestrator",
            "escalation": "Exit with code 0"
          },
          {
            "error_condition": "Worker spawn fails",
            "recovery_action": "Retry spawn up to 3 times with 5s delay",
            "escalation": "Log error and halt pipeline"
          },
          {
            "error_condition": "Worker timeout (>30 minutes)",
            "recovery_action": "Kill Worker and log timeout",
            "escalation": "Mark task as blocked and continue to next"
          },
          {
            "error_condition": "Status Fragment not found",
            "recovery_action": "Generate minimal ADR entry from observation log",
            "escalation": "Log warning and continue"
          }
        ]
      },
      {
        "id": "FLOW-004",
        "name": "ADR Management",
        "description": "Shift Manager logs architectural decisions from Worker outputs to preserve project history across agent lifetimes.",
        "feature_id": "FR-002",
        "story_ids": [
          "ST-007"
        ],
        "actor": "system",
        "trigger": "Worker completes task and generates Status Fragment",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Manager reads Worker Status Fragment from temp file",
            "actor": "system",
            "inputs": [
              ".agent/status_fragment.md"
            ],
            "outputs": [
              "raw_status_fragment"
            ],
            "conditions": [
              "file_exists",
              "file_size < 500 tokens"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Manager extracts architectural decisions from Status Fragment",
            "actor": "system",
            "inputs": [
              "raw_status_fragment"
            ],
            "outputs": [
              "decisions_list",
              "patterns_used",
              "rationale"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Manager retrieves current git commit hash",
            "actor": "system",
            "inputs": [
              "git_log"
            ],
            "outputs": [
              "commit_hash"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Manager formats ADR entry with why, not just what",
            "actor": "system",
            "inputs": [
              "decisions_list",
              "commit_hash",
              "task_id",
              "rationale"
            ],
            "outputs": [
              "formatted_adr_entry"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Manager appends ADR entry to .agent/ADR.md",
            "actor": "system",
            "inputs": [
              "formatted_adr_entry"
            ],
            "outputs": [
              "updated_ADR.md"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Manager validates ADR entry contains required fields",
            "actor": "system",
            "inputs": [
              "updated_ADR.md"
            ],
            "outputs": [
              "validation_result"
            ],
            "conditions": [
              "has_commit_hash",
              "has_task_id",
              "has_rationale",
              "has_timestamp"
            ],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Manager cleans up Status Fragment temp file",
            "actor": "system",
            "inputs": [
              ".agent/status_fragment.md"
            ],
            "outputs": [
              "cleanup_confirmation"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "Worker Status Fragment read after task completion",
          "Decisions distilled into .agent/ADR.md entries",
          "Each ADR entry linked to specific commit hash",
          "Why preserved, not just what, for each decision",
          "ADR entries searchable via RipGrep keywords"
        ],
        "error_handling": [
          {
            "error_condition": "Status Fragment missing",
            "recovery_action": "Generate minimal entry from task description",
            "escalation": "Log warning about missing Worker output"
          },
          {
            "error_condition": "Git commit hash unavailable",
            "recovery_action": "Use 'uncommitted' placeholder",
            "escalation": "Log warning and continue"
          },
          {
            "error_condition": "ADR.md write permission denied",
            "recovery_action": "Retry with elevated permissions",
            "escalation": "Store entry in temp file for manual addition"
          },
          {
            "error_condition": "Status Fragment exceeds 500 token limit",
            "recovery_action": "Truncate to essential decisions",
            "escalation": "Log full fragment to separate debug file"
          }
        ]
      },
      {
        "id": "FLOW-005",
        "name": "Shift Handoff Protocol",
        "description": "Enables successor Shift Managers to read handoff documents and resume the roadmap without context loss.",
        "feature_id": "FR-002",
        "story_ids": [
          "ST-008"
        ],
        "actor": "system",
        "trigger": "Current Shift Manager context exceeds 60% threshold OR new Manager instance starts",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Outgoing Manager compiles accomplishments from current shift",
            "actor": "system",
            "inputs": [
              "session_history",
              "completed_tasks"
            ],
            "outputs": [
              "accomplishments_list"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Manager documents Architecture Delta (changes made this shift)",
            "actor": "system",
            "inputs": [
              "ADR.md_recent_entries",
              "code_changes"
            ],
            "outputs": [
              "architecture_delta"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Manager identifies and documents current blockers",
            "actor": "system",
            "inputs": [
              "failed_tasks",
              "pending_issues"
            ],
            "outputs": [
              "blockers_list"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Manager summarizes last 5 ADR entries for quick context",
            "actor": "system",
            "inputs": [
              "ADR.md"
            ],
            "outputs": [
              "adr_summary"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Manager verifies IMPLEMENTATION_PLAN.md accuracy",
            "actor": "system",
            "inputs": [
              "IMPLEMENTATION_PLAN.md",
              "git_log"
            ],
            "outputs": [
              "plan_verification_result"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Manager writes SHIFT_HANDOFF.md with complete context",
            "actor": "system",
            "inputs": [
              "accomplishments_list",
              "architecture_delta",
              "blockers_list",
              "adr_summary"
            ],
            "outputs": [
              "SHIFT_HANDOFF.md"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Manager exits with code 10 signaling rotation",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "exit_code_10"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Orchestrator spawns new Manager instance with HANDOFF_FILE",
            "actor": "system",
            "inputs": [
              "SHIFT_HANDOFF.md"
            ],
            "outputs": [
              "new_manager_instance"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "New Manager reads SHIFT_HANDOFF.md to acquire context",
            "actor": "system",
            "inputs": [
              "SHIFT_HANDOFF.md"
            ],
            "outputs": [
              "inherited_context"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "New Manager resumes from exact roadmap position",
            "actor": "system",
            "inputs": [
              "IMPLEMENTATION_PLAN.md",
              "inherited_context"
            ],
            "outputs": [
              "resumed_operation"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "SHIFT_HANDOFF.md contains: Accomplishments, Architecture Delta, Blockers",
          "Last 5 ADR entries summarized for quick context",
          "IMPLEMENTATION_PLAN.md accuracy verified before handoff",
          "New Manager resumes from exact roadmap position",
          "Zero context loss between Manager rotations"
        ],
        "error_handling": [
          {
            "error_condition": "SHIFT_HANDOFF.md write fails",
            "recovery_action": "Retry write up to 3 times",
            "escalation": "Output handoff to stdout for manual capture"
          },
          {
            "error_condition": "New Manager fails to start",
            "recovery_action": "Orchestrator retries spawn with delay",
            "escalation": "Halt pipeline and alert user"
          },
          {
            "error_condition": "IMPLEMENTATION_PLAN.md out of sync",
            "recovery_action": "Reconcile plan with git history",
            "escalation": "Mark discrepancies in handoff document"
          },
          {
            "error_condition": "ADR.md has fewer than 5 entries",
            "recovery_action": "Include all available entries",
            "escalation": "Note limited history in handoff"
          }
        ]
      },
      {
        "id": "FLOW-006",
        "name": "Worker Fresh Boot and Ralph Wiggum Loop Execution",
        "description": "Worker starts with a clean 0-token context and executes the Ralph Wiggum Loop (Edit -> Build -> Test -> Fix) until task completion.",
        "feature_id": "FR-003",
        "story_ids": [
          "ST-009",
          "ST-010"
        ],
        "actor": "system",
        "trigger": "Orchestrator spawns new Worker instance for atomic task",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Worker process starts with empty context window (0 tokens)",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "fresh_worker_instance"
            ],
            "conditions": [
              "no_previous_context",
              "no_memory_retention"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Worker receives minimal context injection: PRD.md reference, current_task.md",
            "actor": "system",
            "inputs": [
              "specs/PRD.md",
              ".agent/current_task.md"
            ],
            "outputs": [
              "injected_context"
            ],
            "conditions": [
              "context_fill ~5-10%"
            ],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Worker reads task specification and identifies target files",
            "actor": "system",
            "inputs": [
              ".agent/current_task.md"
            ],
            "outputs": [
              "task_understanding",
              "target_files"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Worker checks for LAST_COMPILER_ERROR.log from previous attempts",
            "actor": "system",
            "inputs": [
              ".agent/LAST_COMPILER_ERROR.log"
            ],
            "outputs": [
              "previous_error_context"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "RALPH LOOP START: Worker executes code edits based on task specification",
            "actor": "system",
            "inputs": [
              "task_understanding",
              "target_files"
            ],
            "outputs": [
              "code_changes"
            ],
            "conditions": [
              "edits_atomic",
              "max_files <= 5",
              "max_loc <= 150"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Worker runs LLVM/compiler after edit",
            "actor": "system",
            "inputs": [
              "code_changes"
            ],
            "outputs": [
              "compiler_result",
              "compiler_exit_code"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007",
              "STEP-010"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "If compile fails: Capture error to LAST_COMPILER_ERROR.log",
            "actor": "system",
            "inputs": [
              "compiler_result"
            ],
            "outputs": [
              "LAST_COMPILER_ERROR.log"
            ],
            "conditions": [
              "compiler_exit_code != 0"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Worker reads error and prepares fix",
            "actor": "system",
            "inputs": [
              "LAST_COMPILER_ERROR.log"
            ],
            "outputs": [
              "fix_plan"
            ],
            "conditions": [
              "retry_count < 5"
            ],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Increment retry counter and return to Edit step",
            "actor": "system",
            "inputs": [
              "fix_plan"
            ],
            "outputs": [
              "retry_count++"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "If compile succeeds: Run unit tests",
            "actor": "system",
            "inputs": [
              "compiled_code"
            ],
            "outputs": [
              "test_result",
              "test_exit_code"
            ],
            "conditions": [
              "compiler_exit_code = 0"
            ],
            "next_steps": [
              "STEP-011",
              "STEP-012"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "If tests fail: Capture output and return to Edit step",
            "actor": "system",
            "inputs": [
              "test_result"
            ],
            "outputs": [
              "test_error_context"
            ],
            "conditions": [
              "test_exit_code != 0",
              "retry_count < 5"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "If tests pass: RALPH LOOP SUCCESS - Proceed to commit",
            "actor": "system",
            "inputs": [
              "test_result"
            ],
            "outputs": [
              "success_signal"
            ],
            "conditions": [
              "test_exit_code = 0"
            ],
            "next_steps": [
              "STEP-013"
            ]
          },
          {
            "id": "STEP-013",
            "sequence": 13,
            "action": "Worker commits changes with descriptive message",
            "actor": "system",
            "inputs": [
              "code_changes",
              "task_id"
            ],
            "outputs": [
              "git_commit"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-014"
            ]
          },
          {
            "id": "STEP-014",
            "sequence": 14,
            "action": "Clear LAST_COMPILER_ERROR.log on success",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "cleared_error_log"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "Worker starts with empty context window (0 tokens)",
          "Initial context fill approximately 5-10% after injection",
          "Code edits verified by LLVM/compiler after each change",
          "Unit tests run after successful compilation",
          "Loop continues until all tests pass (exit code 0)",
          "Maximum 5 retry attempts before escalation"
        ],
        "error_handling": [
          {
            "error_condition": "Retry count exceeds 5",
            "recovery_action": "Write escalation status and terminate",
            "escalation": "Manager notified of blocked task"
          },
          {
            "error_condition": "Context fill exceeds 40%",
            "recovery_action": "Terminate and spawn fresh Worker",
            "escalation": "Task marked for retry with fresh instance"
          },
          {
            "error_condition": "Target file not found",
            "recovery_action": "Report to Manager via status fragment",
            "escalation": "Task may need specification update"
          },
          {
            "error_condition": "Compiler not available",
            "recovery_action": "Log error and terminate immediately",
            "escalation": "Pipeline halted until environment fixed"
          }
        ]
      },
      {
        "id": "FLOW-007",
        "name": "Worker Status Fragment and Self-Destruct",
        "description": "Worker generates a compact status fragment documenting decisions before terminating and garbage collecting its context.",
        "feature_id": "FR-003",
        "story_ids": [
          "ST-011",
          "ST-012"
        ],
        "actor": "system",
        "trigger": "Worker completes Ralph Wiggum Loop successfully OR max retries exceeded",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Worker compiles list of what was fixed during task",
            "actor": "system",
            "inputs": [
              "edit_history",
              "error_fixes"
            ],
            "outputs": [
              "fixes_summary"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Worker documents what was changed with file paths and line numbers",
            "actor": "system",
            "inputs": [
              "git_diff",
              "modified_files"
            ],
            "outputs": [
              "changes_detail"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Worker records patterns and approaches used",
            "actor": "system",
            "inputs": [
              "implementation_decisions"
            ],
            "outputs": [
              "patterns_used"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Worker formats Status Fragment in compact format (<500 tokens)",
            "actor": "system",
            "inputs": [
              "fixes_summary",
              "changes_detail",
              "patterns_used"
            ],
            "outputs": [
              "formatted_fragment"
            ],
            "conditions": [
              "token_count < 500"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Worker writes Status Fragment to temp file for Manager consumption",
            "actor": "system",
            "inputs": [
              "formatted_fragment"
            ],
            "outputs": [
              ".agent/status_fragment.md"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Worker signals task completion to Orchestrator",
            "actor": "system",
            "inputs": [
              "task_status"
            ],
            "outputs": [
              "completion_signal"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Worker process terminates (self-destruct)",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "process_terminated"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Orchestrator kills Worker process if still alive",
            "actor": "system",
            "inputs": [
              "worker_pid"
            ],
            "outputs": [
              "process_killed"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "System garbage collects Worker memory completely",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "memory_cleared"
            ],
            "conditions": [
              "no_state_persists"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Telemetry reset to 0% context for Worker indicator",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "telemetry_reset"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "Status Fragment documents: What was fixed, What was changed, What patterns used",
          "Status Fragment written to temp file for Manager consumption",
          "Fragment includes specific file paths and line numbers modified",
          "Compact format maintained (<500 tokens)",
          "Process killed after successful commit",
          "Memory cleared completely with no state persistence",
          "Telemetry JSON reset to 0% context"
        ],
        "error_handling": [
          {
            "error_condition": "Status Fragment write fails",
            "recovery_action": "Output to stdout for Orchestrator capture",
            "escalation": "Log warning and proceed with termination"
          },
          {
            "error_condition": "Process fails to terminate",
            "recovery_action": "Orchestrator sends SIGKILL",
            "escalation": "Force kill and log zombie process"
          },
          {
            "error_condition": "Telemetry reset fails",
            "recovery_action": "Retry reset up to 3 times",
            "escalation": "Log error but proceed with next Worker"
          },
          {
            "error_condition": "Status Fragment exceeds 500 tokens",
            "recovery_action": "Truncate to essential information",
            "escalation": "Log full fragment to debug file"
          }
        ]
      },
      {
        "id": "FLOW-008",
        "name": "Guardrail System Verification",
        "description": "Continuous quality control using LLVM/Static analysis, linting, and test suites that enforce back pressure to prevent bad code from being committed.",
        "feature_id": "FR-004",
        "story_ids": [
          "ST-013",
          "ST-014",
          "ST-015"
        ],
        "actor": "system",
        "trigger": "Worker attempts to commit code changes",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Guardrail system intercepts commit attempt",
            "actor": "system",
            "inputs": [
              "staged_changes"
            ],
            "outputs": [
              "verification_queue"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Run TypeScript compiler (tsc) verification",
            "actor": "system",
            "inputs": [
              "staged_changes"
            ],
            "outputs": [
              "tsc_result",
              "tsc_exit_code"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003",
              "STEP-004"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "If tsc fails: Capture error to LAST_COMPILER_ERROR.log and block commit",
            "actor": "system",
            "inputs": [
              "tsc_result"
            ],
            "outputs": [
              "LAST_COMPILER_ERROR.log",
              "commit_blocked"
            ],
            "conditions": [
              "tsc_exit_code != 0"
            ],
            "next_steps": []
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "If tsc passes: Proceed to unit test verification",
            "actor": "system",
            "inputs": [
              "tsc_result"
            ],
            "outputs": [
              "proceed_to_tests"
            ],
            "conditions": [
              "tsc_exit_code = 0"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Run unit test suite (Vitest/Jest)",
            "actor": "system",
            "inputs": [
              "compiled_code"
            ],
            "outputs": [
              "test_result",
              "coverage_report"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006",
              "STEP-007"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "If tests fail: Block commit and log test output",
            "actor": "system",
            "inputs": [
              "test_result"
            ],
            "outputs": [
              "test_failure_log",
              "commit_blocked"
            ],
            "conditions": [
              "test_exit_code != 0"
            ],
            "next_steps": []
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "If tests pass: Verify coverage thresholds",
            "actor": "system",
            "inputs": [
              "coverage_report"
            ],
            "outputs": [
              "coverage_check"
            ],
            "conditions": [
              "services_coverage > 90%",
              "controllers_coverage > 80%"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Run KreativReason standards audit via RipGrep",
            "actor": "system",
            "inputs": [
              "staged_changes"
            ],
            "outputs": [
              "standards_audit_result"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-009",
              "STEP-010",
              "STEP-011"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Verify multi-tenancy: Every Prisma query includes tenantId",
            "actor": "system",
            "inputs": [
              "prisma_queries"
            ],
            "outputs": [
              "tenant_audit_result"
            ],
            "conditions": [
              "all_queries_have_tenantId"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Verify validation: All input validated with Zod schemas",
            "actor": "system",
            "inputs": [
              "api_endpoints"
            ],
            "outputs": [
              "validation_audit_result"
            ],
            "conditions": [
              "all_inputs_validated"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Verify exports: Only named exports (no export default)",
            "actor": "system",
            "inputs": [
              "module_exports"
            ],
            "outputs": [
              "export_audit_result"
            ],
            "conditions": [
              "no_default_exports"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "If all audits pass: Allow commit to proceed",
            "actor": "system",
            "inputs": [
              "all_audit_results"
            ],
            "outputs": [
              "commit_allowed"
            ],
            "conditions": [
              "all_checks_passed"
            ],
            "next_steps": [
              "STEP-013"
            ]
          },
          {
            "id": "STEP-013",
            "sequence": 13,
            "action": "Log guardrail verification results for Manager review",
            "actor": "system",
            "inputs": [
              "all_audit_results"
            ],
            "outputs": [
              "guardrail_log"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "No commit allowed unless compiler passes (exit code 0)",
          "Error output captured to LAST_COMPILER_ERROR.log",
          "Task completion requires passing tests",
          "Target >90% coverage for Services, >80% for Controllers",
          "Every Prisma query includes tenantId",
          "All input validated with Zod schemas",
          "Only named exports (no export default)"
        ],
        "error_handling": [
          {
            "error_condition": "Compiler crashes",
            "recovery_action": "Log crash and block commit",
            "escalation": "Alert about environment issue"
          },
          {
            "error_condition": "Test runner unavailable",
            "recovery_action": "Block commit and log error",
            "escalation": "Pipeline halted until test runner restored"
          },
          {
            "error_condition": "RipGrep audit timeout",
            "recovery_action": "Retry with increased timeout",
            "escalation": "Warn and proceed with partial audit"
          },
          {
            "error_condition": "Coverage below threshold",
            "recovery_action": "Block commit and report coverage gap",
            "escalation": "Task must add tests before proceeding"
          }
        ]
      },
      {
        "id": "FLOW-009",
        "name": "Orchestrator Manager Lifecycle",
        "description": "Manages Shift Manager instance lifecycles including launching, monitoring exit codes, and handling rotation at 60% context threshold.",
        "feature_id": "FR-005",
        "story_ids": [
          "ST-016"
        ],
        "actor": "system",
        "trigger": "User executes /...loop command OR previous Manager rotates",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Orchestrator checks for existing SHIFT_HANDOFF.md file",
            "actor": "system",
            "inputs": [
              "filesystem"
            ],
            "outputs": [
              "handoff_exists"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002",
              "STEP-003"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "If handoff exists: Prepare Manager launch with handoff context",
            "actor": "system",
            "inputs": [
              "SHIFT_HANDOFF.md"
            ],
            "outputs": [
              "manager_args_with_handoff"
            ],
            "conditions": [
              "handoff_exists = true"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "If no handoff: Prepare fresh Manager launch",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "manager_args_fresh"
            ],
            "conditions": [
              "handoff_exists = false"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Launch new Shift Manager Claude Code instance",
            "actor": "system",
            "inputs": [
              "manager_args"
            ],
            "outputs": [
              "manager_pid",
              "manager_process"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Monitor Manager process and capture output",
            "actor": "system",
            "inputs": [
              "manager_process"
            ],
            "outputs": [
              "manager_stdout",
              "manager_stderr"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Wait for Manager exit and capture exit code",
            "actor": "system",
            "inputs": [
              "manager_process"
            ],
            "outputs": [
              "exit_code"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007",
              "STEP-008",
              "STEP-009"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "If exit code 0: Roadmap complete - terminate loop",
            "actor": "system",
            "inputs": [
              "exit_code"
            ],
            "outputs": [
              "loop_complete"
            ],
            "conditions": [
              "exit_code = 0"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "If exit code 10: Rotation required - restart Manager",
            "actor": "system",
            "inputs": [
              "exit_code"
            ],
            "outputs": [
              "rotation_signal"
            ],
            "conditions": [
              "exit_code = 10"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "If other exit code: Error condition - handle recovery",
            "actor": "system",
            "inputs": [
              "exit_code"
            ],
            "outputs": [
              "error_signal"
            ],
            "conditions": [
              "exit_code != 0",
              "exit_code != 10"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Kill old Manager process and spawn fresh instance",
            "actor": "system",
            "inputs": [
              "manager_pid"
            ],
            "outputs": [
              "new_manager_spawn"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-001"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Handle error: Log and implement retry with 5s delay",
            "actor": "system",
            "inputs": [
              "error_signal",
              "retry_count"
            ],
            "outputs": [
              "retry_decision"
            ],
            "conditions": [
              "retry_count < 3"
            ],
            "next_steps": [
              "STEP-001"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Pipeline complete: Output final status and clean up",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "completion_status"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "Fresh Manager launched with HANDOFF_FILE if exists",
          "Exit codes monitored: 0=complete, 10=rotate, other=error",
          "Manager killed and restarted on rotation signal",
          "Loop maintained until roadmap 100% complete",
          "Clean termination on project completion"
        ],
        "error_handling": [
          {
            "error_condition": "Manager fails to start",
            "recovery_action": "Retry launch up to 3 times with 5s delay",
            "escalation": "Halt and alert user"
          },
          {
            "error_condition": "Unexpected exit code",
            "recovery_action": "Log error and retry with delay",
            "escalation": "Halt after 3 consecutive failures"
          },
          {
            "error_condition": "SHIFT_HANDOFF.md corrupted",
            "recovery_action": "Start fresh Manager without handoff",
            "escalation": "Log loss of context continuity"
          },
          {
            "error_condition": "Manager process becomes zombie",
            "recovery_action": "Force SIGKILL and restart",
            "escalation": "Log zombie process for debugging"
          }
        ]
      },
      {
        "id": "FLOW-010",
        "name": "Orchestrator Worker Spawning and Error Recovery",
        "description": "Spawns stateless Workers for each task ensuring fresh context, handles Worker lifecycle, and implements error recovery with retry logic.",
        "feature_id": "FR-005",
        "story_ids": [
          "ST-017",
          "ST-018"
        ],
        "actor": "system",
        "trigger": "Shift Manager signals need for new Worker instance",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Orchestrator receives Worker spawn request from Manager",
            "actor": "system",
            "inputs": [
              "spawn_request",
              "task_context"
            ],
            "outputs": [
              "spawn_job"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Prepare minimal context injection for Worker",
            "actor": "system",
            "inputs": [
              "task_context"
            ],
            "outputs": [
              "context_injection"
            ],
            "conditions": [
              "injection_size < 10% context"
            ],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Spawn new Claude Code instance for Worker",
            "actor": "system",
            "inputs": [
              "context_injection"
            ],
            "outputs": [
              "worker_pid",
              "worker_process"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Monitor Worker process execution",
            "actor": "system",
            "inputs": [
              "worker_process"
            ],
            "outputs": [
              "worker_stdout",
              "worker_stderr"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Wait for Worker completion or timeout (30 min max)",
            "actor": "system",
            "inputs": [
              "worker_process",
              "timeout_30min"
            ],
            "outputs": [
              "worker_exit_code",
              "completion_reason"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006",
              "STEP-007",
              "STEP-010"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "If Worker succeeded: Kill process and reset telemetry",
            "actor": "system",
            "inputs": [
              "worker_exit_code"
            ],
            "outputs": [
              "process_terminated"
            ],
            "conditions": [
              "worker_exit_code = 0"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "If Worker failed: Capture error state",
            "actor": "system",
            "inputs": [
              "worker_exit_code",
              "worker_stderr"
            ],
            "outputs": [
              "error_capture"
            ],
            "conditions": [
              "worker_exit_code != 0"
            ],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Reset telemetry.json to 0% Worker context",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "telemetry_reset"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Implement error recovery: 5s sleep before retry decision",
            "actor": "system",
            "inputs": [
              "error_capture",
              "retry_count"
            ],
            "outputs": [
              "retry_decision"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "If retry available (count < 3): Spawn new Worker",
            "actor": "system",
            "inputs": [
              "retry_decision"
            ],
            "outputs": [
              "retry_spawn"
            ],
            "conditions": [
              "consecutive_crashes < 3"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Signal Manager with Worker completion status",
            "actor": "system",
            "inputs": [
              "worker_exit_code"
            ],
            "outputs": [
              "completion_signal"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "New Claude Code instance spawned for each task",
          "Only minimal context injection passed to Worker",
          "Worker process killed after task completion",
          "telemetry.json reset to 0% after Worker death",
          "5-second sleep implemented before retry",
          "Maximum 3 consecutive crash retries before halt",
          "Crash information logged for debugging"
        ],
        "error_handling": [
          {
            "error_condition": "Worker spawn fails",
            "recovery_action": "Retry spawn with 5s delay",
            "escalation": "Halt after 3 consecutive spawn failures"
          },
          {
            "error_condition": "Worker timeout (>30 min)",
            "recovery_action": "Force kill and log timeout",
            "escalation": "Mark task as blocked"
          },
          {
            "error_condition": "Consecutive crashes exceed 3",
            "recovery_action": "Halt Worker spawning",
            "escalation": "Notify Manager of persistent failure"
          },
          {
            "error_condition": "Telemetry reset fails",
            "recovery_action": "Retry reset up to 3 times",
            "escalation": "Log error and continue with warning"
          }
        ]
      },
      {
        "id": "FLOW-011",
        "name": "File-Based State Management",
        "description": "Persistent memory system using markdown files as the 'brain outside the AI' to maintain coherence across stateless agent lifetimes.",
        "feature_id": "FR-006",
        "story_ids": [
          "ST-019",
          "ST-020",
          "ST-021"
        ],
        "actor": "system",
        "trigger": "Any agent needs to read or write project state",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Agent identifies state file needed for operation",
            "actor": "system",
            "inputs": [
              "operation_type"
            ],
            "outputs": [
              "target_file_path"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002",
              "STEP-005",
              "STEP-008"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "IMPLEMENTATION_PLAN.md: Read current task list with checkboxes",
            "actor": "system",
            "inputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "outputs": [
              "task_list",
              "progress_status"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Parse [ ] and [x] checkbox syntax for task status",
            "actor": "system",
            "inputs": [
              "task_list"
            ],
            "outputs": [
              "unchecked_count",
              "checked_count",
              "progress_percent"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Update task status: Mark [x] for completed, [ ] for pending",
            "actor": "system",
            "inputs": [
              "task_id",
              "new_status"
            ],
            "outputs": [
              "updated_IMPLEMENTATION_PLAN.md"
            ],
            "conditions": [
              "task_has_unique_id"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "ADR.md: Read architectural decision history",
            "actor": "system",
            "inputs": [
              "ADR.md"
            ],
            "outputs": [
              "decision_history"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Search ADR entries via RipGrep keywords",
            "actor": "system",
            "inputs": [
              "search_keywords"
            ],
            "outputs": [
              "matching_entries"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Append new ADR entry with commit hash, task ID, rationale",
            "actor": "system",
            "inputs": [
              "new_decision",
              "commit_hash",
              "task_id"
            ],
            "outputs": [
              "updated_ADR.md"
            ],
            "conditions": [
              "entry_has_rationale"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "LAST_COMPILER_ERROR.log: Check for previous error state",
            "actor": "system",
            "inputs": [
              "LAST_COMPILER_ERROR.log"
            ],
            "outputs": [
              "error_context"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Truncate error to essential information (<1000 tokens)",
            "actor": "system",
            "inputs": [
              "raw_error"
            ],
            "outputs": [
              "truncated_error"
            ],
            "conditions": [
              "token_count < 1000"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Clear error log after successful compilation",
            "actor": "system",
            "inputs": [
              "compilation_success"
            ],
            "outputs": [
              "cleared_error_log"
            ],
            "conditions": [
              "compiler_exit_code = 0"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Confirm state file operation completed",
            "actor": "system",
            "inputs": [
              "operation_result"
            ],
            "outputs": [
              "confirmation"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "IMPLEMENTATION_PLAN.md uses [ ] and [x] checkbox syntax",
          "Tasks ordered by dependency in plan",
          "Each task has unique ID (ST-01, ST-02, etc.)",
          "Progress calculable via regex matching",
          "ADR.md maintains chronological log with commit links",
          "ADR entries include rationale, not just description",
          "LAST_COMPILER_ERROR.log truncated to <1000 tokens",
          "Error log cleared after successful compilation"
        ],
        "error_handling": [
          {
            "error_condition": "State file not found",
            "recovery_action": "Create file with empty/default template",
            "escalation": "Log warning about missing state"
          },
          {
            "error_condition": "File write permission denied",
            "recovery_action": "Retry with elevated permissions",
            "escalation": "Store in alternative location"
          },
          {
            "error_condition": "Checkbox parsing fails",
            "recovery_action": "Use fallback regex pattern",
            "escalation": "Report malformed plan file"
          },
          {
            "error_condition": "Concurrent write conflict",
            "recovery_action": "Retry with file locking",
            "escalation": "Queue write for later execution"
          }
        ]
      },
      {
        "id": "FLOW-012",
        "name": "Dashboard Visualization",
        "description": "Real-time Mission Control HUD providing visibility into context health, task velocity, cost tracking, and guardrail status.",
        "feature_id": "FR-007",
        "story_ids": [
          "ST-022",
          "ST-023",
          "ST-024",
          "ST-025"
        ],
        "actor": "user",
        "trigger": "User opens dashboard at http://localhost:3000",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "User navigates to http://localhost:3000 in browser",
            "actor": "user",
            "inputs": [
              "browser_request"
            ],
            "outputs": [
              "html_dashboard"
            ],
            "conditions": [
              "watcher_running"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Dashboard establishes WebSocket connection to Watcher",
            "actor": "system",
            "inputs": [
              "socket_connection"
            ],
            "outputs": [
              "connected_client"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Watcher sends initial state snapshot to client",
            "actor": "system",
            "inputs": [
              "current_telemetry",
              "current_roadmap"
            ],
            "outputs": [
              "initial_state"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Dashboard renders Context Window Progress Bars",
            "actor": "system",
            "inputs": [
              "manager_context_percent",
              "worker_context_percent"
            ],
            "outputs": [
              "context_bars_ui"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Apply color coding based on zone status",
            "actor": "system",
            "inputs": [
              "context_percent"
            ],
            "outputs": [
              "bar_color"
            ],
            "conditions": [
              "Blue (#00d2ff): <40% Smart Zone",
              "Orange: 40-60% Degrading",
              "Red (#ff4b2b): >60% Dumb Zone"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Dashboard renders Roadmap Progress Visualization",
            "actor": "system",
            "inputs": [
              "completed_tasks",
              "total_tasks",
              "current_task"
            ],
            "outputs": [
              "roadmap_ui"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Display completed/total ratio and current active task",
            "actor": "system",
            "inputs": [
              "progress_data"
            ],
            "outputs": [
              "progress_display"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Dashboard renders Cost Tracking Display",
            "actor": "system",
            "inputs": [
              "elapsed_time",
              "cost_rate"
            ],
            "outputs": [
              "cost_ui"
            ],
            "conditions": [
              "cost_rate = $10.42/hour"
            ],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Calculate tasks per hour velocity",
            "actor": "system",
            "inputs": [
              "tasks_completed",
              "elapsed_hours"
            ],
            "outputs": [
              "velocity_metric"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Dashboard renders Guardrail Status Panel",
            "actor": "system",
            "inputs": [
              "tsc_status",
              "tenancy_audit",
              "test_coverage"
            ],
            "outputs": [
              "guardrail_ui"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Display red/green indicators for each guardrail check",
            "actor": "system",
            "inputs": [
              "check_results"
            ],
            "outputs": [
              "status_indicators"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Listen for real-time telemetry updates via WebSocket",
            "actor": "system",
            "inputs": [
              "socket_events"
            ],
            "outputs": [
              "live_updates"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          }
        ],
        "success_criteria": [
          "Manager bar shows steady growth with blue/cyan in Smart Zone",
          "Worker bar pulses and resets to 0% on task completion",
          "Color states: Blue (<40%), Orange (40-60%), Red (>60%)",
          "Smooth CSS transitions with neon-liquid aesthetic",
          "Shows completed/total tasks ratio",
          "Displays current active task title",
          "Running cost displayed at $10.42/hour rate",
          "TypeScript, Multi-tenancy, Coverage status visible",
          "Red/green indicators for pass/fail"
        ],
        "error_handling": [
          {
            "error_condition": "WebSocket connection fails",
            "recovery_action": "Retry connection with exponential backoff",
            "escalation": "Display offline status to user"
          },
          {
            "error_condition": "Telemetry data malformed",
            "recovery_action": "Use last known good state",
            "escalation": "Display data error indicator"
          },
          {
            "error_condition": "Watcher server not running",
            "recovery_action": "Show connection error message",
            "escalation": "Prompt user to start watcher"
          },
          {
            "error_condition": "Browser doesn't support WebSocket",
            "recovery_action": "Fall back to polling",
            "escalation": "Display compatibility warning"
          }
        ]
      },
      {
        "id": "FLOW-013",
        "name": "WebSocket Bridge Data Flow",
        "description": "Real-time bridge between CLI-based agents writing to disk and the HTML Dashboard displaying state using Socket.io.",
        "feature_id": "FR-008",
        "story_ids": [
          "ST-026",
          "ST-027",
          "ST-028"
        ],
        "actor": "system",
        "trigger": "Watcher server starts OR file change detected",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Watcher server starts and initializes Express.js",
            "actor": "system",
            "inputs": [
              "server_config"
            ],
            "outputs": [
              "express_server"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Express serves static files from /public directory",
            "actor": "system",
            "inputs": [
              "public_directory"
            ],
            "outputs": [
              "static_file_server"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Initialize Socket.io on Express server",
            "actor": "system",
            "inputs": [
              "express_server"
            ],
            "outputs": [
              "socket_io_instance"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Set up fs.watch on .ralph/telemetry.json",
            "actor": "system",
            "inputs": [
              "telemetry_path"
            ],
            "outputs": [
              "telemetry_watcher"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Set up fs.watchFile on IMPLEMENTATION_PLAN.md",
            "actor": "system",
            "inputs": [
              "roadmap_path"
            ],
            "outputs": [
              "roadmap_watcher"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Telemetry file change detected",
            "actor": "system",
            "inputs": [
              "file_change_event"
            ],
            "outputs": [
              "change_notification"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Parse telemetry.json content",
            "actor": "system",
            "inputs": [
              "file_content"
            ],
            "outputs": [
              "telemetry_data"
            ],
            "conditions": [
              "valid_json"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Emit 'telemetry' event via Socket.io to all clients",
            "actor": "system",
            "inputs": [
              "telemetry_data"
            ],
            "outputs": [
              "socket_emit"
            ],
            "conditions": [
              "latency < 100ms"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Roadmap file change detected",
            "actor": "system",
            "inputs": [
              "file_change_event"
            ],
            "outputs": [
              "roadmap_notification"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Count [x] vs [ ] checkboxes in roadmap",
            "actor": "system",
            "inputs": [
              "roadmap_content"
            ],
            "outputs": [
              "completed_count",
              "total_count",
              "progress_percent"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Emit 'roadmap' event via Socket.io with progress data",
            "actor": "system",
            "inputs": [
              "progress_data"
            ],
            "outputs": [
              "socket_emit"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Handle client connection/disconnection gracefully",
            "actor": "system",
            "inputs": [
              "socket_event"
            ],
            "outputs": [
              "connection_status"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "fs.watch monitors .ralph/telemetry.json for changes",
          "JSON parsed and 'telemetry' event emitted via Socket.io",
          "Partial/empty file writes handled gracefully",
          "Sub-100ms latency from file change to UI update",
          "fs.watchFile monitors IMPLEMENTATION_PLAN.md",
          "[x] vs [ ] checkboxes counted for progress",
          "'roadmap' event emitted with progress percentage",
          "Express serves /public directory",
          "Dashboard accessible at http://localhost:3000",
          "Multiple concurrent browser connections supported"
        ],
        "error_handling": [
          {
            "error_condition": "Partial/empty file write",
            "recovery_action": "Wait 50ms and retry parse",
            "escalation": "Skip update and wait for next change"
          },
          {
            "error_condition": "Invalid JSON in telemetry",
            "recovery_action": "Use last valid state",
            "escalation": "Log parse error for debugging"
          },
          {
            "error_condition": "File watcher fails",
            "recovery_action": "Re-initialize watcher",
            "escalation": "Fall back to polling"
          },
          {
            "error_condition": "Socket.io client disconnect",
            "recovery_action": "Clean up client state",
            "escalation": "Log disconnect for monitoring"
          }
        ]
      },
      {
        "id": "FLOW-014",
        "name": "Crisis Mode Activation",
        "description": "Emergency override capability that immediately terminates all AI processes, reverts code to last commit, and clears telemetry state.",
        "feature_id": "FR-009",
        "story_ids": [
          "ST-029",
          "ST-030",
          "ST-031",
          "ST-032"
        ],
        "actor": "user",
        "trigger": "User clicks Crisis Mode button on dashboard",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "User clicks Crisis Mode button (red with neon-liquid warning glow)",
            "actor": "user",
            "inputs": [
              "button_click"
            ],
            "outputs": [
              "crisis_trigger"
            ],
            "conditions": [
              "no_confirmation_required"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Dashboard provides immediate visual feedback on activation",
            "actor": "system",
            "inputs": [
              "crisis_trigger"
            ],
            "outputs": [
              "visual_feedback"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Dashboard sends crisis signal to Watcher via WebSocket",
            "actor": "system",
            "inputs": [
              "crisis_signal"
            ],
            "outputs": [
              "server_notification"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Watcher executes pkill -f orchestrate.sh",
            "actor": "system",
            "inputs": [
              "kill_command"
            ],
            "outputs": [
              "orchestrator_killed"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Watcher executes pkill -f claude-code",
            "actor": "system",
            "inputs": [
              "kill_command"
            ],
            "outputs": [
              "ai_processes_killed"
            ],
            "conditions": [
              "termination < 2s"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Log all terminations for debugging",
            "actor": "system",
            "inputs": [
              "termination_results"
            ],
            "outputs": [
              "crisis_log"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Execute git reset --hard HEAD",
            "actor": "system",
            "inputs": [
              "git_command"
            ],
            "outputs": [
              "code_reverted"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Clear any uncommitted changes from working directory",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "clean_working_directory"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Preserve git history for forensic analysis",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "history_preserved"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Reset telemetry.json to 0% context for all agents",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "telemetry_reset"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Dashboard bars return to zero state",
            "actor": "system",
            "inputs": [
              "telemetry_reset"
            ],
            "outputs": [
              "ui_reset"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Broadcast system message to all connected clients",
            "actor": "system",
            "inputs": [
              "crisis_complete"
            ],
            "outputs": [
              "broadcast_message"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-013"
            ]
          },
          {
            "id": "STEP-013",
            "sequence": 13,
            "action": "Confirm revert success and ready-for-restart state to frontend",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "confirmation"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "Red button with neon-liquid warning glow visible",
          "Single click triggers crisis protocol (no confirmation)",
          "Visual feedback on activation",
          "pkill -f orchestrate.sh executed",
          "pkill -f claude-code executed",
          "Termination within 2 seconds of button click",
          "git reset --hard HEAD executed",
          "Uncommitted changes cleared",
          "Git history preserved for forensics",
          "telemetry.json reset to 0% context",
          "Dashboard bars return to zero",
          "System message broadcasted to all connected clients",
          "Ready for immediate loop restart"
        ],
        "error_handling": [
          {
            "error_condition": "Process kill fails",
            "recovery_action": "Retry with SIGKILL",
            "escalation": "Report zombie processes to user"
          },
          {
            "error_condition": "Git reset fails",
            "recovery_action": "Force reset with git clean -fd",
            "escalation": "Alert user to manual intervention needed"
          },
          {
            "error_condition": "Telemetry file locked",
            "recovery_action": "Force unlock and overwrite",
            "escalation": "Delete and recreate file"
          },
          {
            "error_condition": "WebSocket disconnected during crisis",
            "recovery_action": "Execute crisis locally anyway",
            "escalation": "User must verify manually"
          }
        ]
      },
      {
        "id": "FLOW-015",
        "name": "Slash Command Execution",
        "description": "Human-friendly CLI commands that abstract complex orchestration into simple intent-based actions.",
        "feature_id": "FR-010",
        "story_ids": [
          "ST-033",
          "ST-034",
          "ST-035",
          "ST-036",
          "ST-037"
        ],
        "actor": "user",
        "trigger": "User types slash command in Claude Code CLI",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "User enters slash command in CLI",
            "actor": "user",
            "inputs": [
              "command_string"
            ],
            "outputs": [
              "parsed_command",
              "command_args"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002",
              "STEP-004",
              "STEP-006",
              "STEP-008",
              "STEP-010"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "/...seed @file: Trigger Distiller with linked file",
            "actor": "system",
            "inputs": [
              "brainstorm_file"
            ],
            "outputs": [
              "distiller_process"
            ],
            "conditions": [
              "command = /...seed"
            ],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Generate specs/PRD.md, specs/index.md, IMPLEMENTATION_PLAN.md",
            "actor": "system",
            "inputs": [
              "distiller_output"
            ],
            "outputs": [
              "generated_specs"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "/...plan: Analyze gap between specs and current code",
            "actor": "system",
            "inputs": [
              "specs",
              "codebase"
            ],
            "outputs": [
              "gap_analysis"
            ],
            "conditions": [
              "command = /...plan"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Update IMPLEMENTATION_PLAN.md with ordered tasks",
            "actor": "system",
            "inputs": [
              "gap_analysis"
            ],
            "outputs": [
              "updated_plan",
              "task_count"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "/...loop: Start orchestrate.sh in background",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "orchestrator_process"
            ],
            "conditions": [
              "command = /...loop"
            ],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Activate Shift Manager and begin Worker cycling",
            "actor": "system",
            "inputs": [
              "orchestrator_process"
            ],
            "outputs": [
              "active_loop",
              "telemetry_streaming"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "/...status: Render DASHBOARD.md in terminal-friendly format",
            "actor": "system",
            "inputs": [
              "current_state"
            ],
            "outputs": [
              "terminal_dashboard"
            ],
            "conditions": [
              "command = /...status"
            ],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Display context %, completed/total tasks, latest ADR",
            "actor": "system",
            "inputs": [
              "telemetry",
              "roadmap",
              "ADR.md"
            ],
            "outputs": [
              "status_display"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "/...digest: Handle unstructured brain dump input",
            "actor": "system",
            "inputs": [
              "messy_paste"
            ],
            "outputs": [
              "parsed_concepts"
            ],
            "conditions": [
              "command = /...digest"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Identify core logic and propose 5-10 atomic tasks",
            "actor": "system",
            "inputs": [
              "parsed_concepts"
            ],
            "outputs": [
              "specs/concepts.md",
              "proposed_tasks"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Output success/failure status to user",
            "actor": "system",
            "inputs": [
              "command_result"
            ],
            "outputs": [
              "status_message"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "/...seed generates specs/PRD.md, specs/index.md, IMPLEMENTATION_PLAN.md",
          "/...plan updates IMPLEMENTATION_PLAN.md with task count reported",
          "/...loop starts orchestrate.sh and activates telemetry",
          "/...status shows context %, tasks completed/total, latest ADR",
          "/...digest creates specs/concepts.md with 5-10 atomic tasks",
          "All commands output clear success/failure status"
        ],
        "error_handling": [
          {
            "error_condition": "Unknown command",
            "recovery_action": "Display available commands list",
            "escalation": "Suggest similar command if typo detected"
          },
          {
            "error_condition": "Missing required argument",
            "recovery_action": "Display command usage",
            "escalation": "Prompt for required input"
          },
          {
            "error_condition": "File not found for /...seed",
            "recovery_action": "Display error with expected path",
            "escalation": "Offer to create empty file"
          },
          {
            "error_condition": "Loop already running for /...loop",
            "recovery_action": "Display current loop status",
            "escalation": "Offer to restart loop"
          }
        ]
      },
      {
        "id": "FLOW-016",
        "name": "Shift Report Generation",
        "description": "End-of-shift documentation that compresses work done into high-density summaries for successor Managers.",
        "feature_id": "FR-011",
        "story_ids": [
          "ST-038",
          "ST-039"
        ],
        "actor": "system",
        "trigger": "Shift Manager reaches 60% context threshold OR manual report request",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Manager initiates shift report generation",
            "actor": "system",
            "inputs": [
              "rotation_trigger"
            ],
            "outputs": [
              "report_job"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Compile Executive Summary of shift accomplishments",
            "actor": "system",
            "inputs": [
              "completed_tasks",
              "session_history"
            ],
            "outputs": [
              "executive_summary"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "List all completed tasks with verification status",
            "actor": "system",
            "inputs": [
              "IMPLEMENTATION_PLAN.md",
              "git_log"
            ],
            "outputs": [
              "completed_tasks_list"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Gather Strategic Memory from ADR entries",
            "actor": "system",
            "inputs": [
              "ADR.md"
            ],
            "outputs": [
              "strategic_memory"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "List architectural decisions made during shift",
            "actor": "system",
            "inputs": [
              "ADR.md_filtered"
            ],
            "outputs": [
              "decisions_list"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Identify persistent friction points and blockers",
            "actor": "system",
            "inputs": [
              "error_logs",
              "retry_counts"
            ],
            "outputs": [
              "friction_points"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Link report to current roadmap position",
            "actor": "system",
            "inputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "outputs": [
              "roadmap_link"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Verify Definition of Done: LLVM/Compiler signal pass",
            "actor": "system",
            "inputs": [
              "compiler_status"
            ],
            "outputs": [
              "compiler_verification"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Verify KreativReason standards compliance",
            "actor": "system",
            "inputs": [
              "audit_results"
            ],
            "outputs": [
              "standards_verification"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Verify all unit tests pass",
            "actor": "system",
            "inputs": [
              "test_results"
            ],
            "outputs": [
              "test_verification"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Document known issues and TODOs",
            "actor": "system",
            "inputs": [
              "open_issues"
            ],
            "outputs": [
              "issues_list"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Write SHIFT_REPORT.md with complete documentation",
            "actor": "system",
            "inputs": [
              "all_report_sections"
            ],
            "outputs": [
              "SHIFT_REPORT.md"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "Report includes: Executive Summary, Completed Tasks, Strategic Memory",
          "Architectural decisions from shift listed",
          "Persistent friction points identified",
          "Report links to current roadmap position",
          "LLVM/Compiler signal verified pass",
          "KreativReason standards compliance confirmed",
          "All unit tests verified passing",
          "Known issues and TODOs documented"
        ],
        "error_handling": [
          {
            "error_condition": "Compiler verification fails",
            "recovery_action": "Document failure in issues section",
            "escalation": "Mark report as incomplete"
          },
          {
            "error_condition": "Test verification fails",
            "recovery_action": "List failing tests in issues",
            "escalation": "Successor must address before continuing"
          },
          {
            "error_condition": "ADR.md inaccessible",
            "recovery_action": "Generate from git commit history",
            "escalation": "Mark strategic memory as incomplete"
          },
          {
            "error_condition": "Report write fails",
            "recovery_action": "Output to stdout for manual capture",
            "escalation": "Handoff proceeds with minimal context"
          }
        ]
      },
      {
        "id": "FLOW-017",
        "name": "Post-Crisis Recovery Analysis",
        "description": "Forensic analysis system that identifies failure causes after Crisis Mode activation to prevent repeat failures.",
        "feature_id": "FR-012",
        "story_ids": [
          "ST-040",
          "ST-041"
        ],
        "actor": "system",
        "trigger": "Recovery agent starts after Crisis Mode activation",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Recovery agent receives post-crisis startup signal",
            "actor": "system",
            "inputs": [
              "recovery_trigger"
            ],
            "outputs": [
              "analysis_job"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Read activity.log for events leading to crisis",
            "actor": "system",
            "inputs": [
              "activity.log"
            ],
            "outputs": [
              "activity_timeline"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Read LAST_COMPILER_ERROR.log for technical failures",
            "actor": "system",
            "inputs": [
              "LAST_COMPILER_ERROR.log"
            ],
            "outputs": [
              "error_details"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Identify trigger category: vague spec, rule violation, or test gap",
            "actor": "system",
            "inputs": [
              "activity_timeline",
              "error_details"
            ],
            "outputs": [
              "trigger_category"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Check if context fill exceeded 60% before failure",
            "actor": "system",
            "inputs": [
              "telemetry_history"
            ],
            "outputs": [
              "context_overflow_status"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Identify specific file causing token spike (if any)",
            "actor": "system",
            "inputs": [
              "file_read_history"
            ],
            "outputs": [
              "problem_file"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Generate root cause analysis report",
            "actor": "system",
            "inputs": [
              "all_analysis_data"
            ],
            "outputs": [
              "root_cause_report"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Clarify ambiguous logic in relevant spec file",
            "actor": "system",
            "inputs": [
              "root_cause_report",
              "spec_files"
            ],
            "outputs": [
              "clarified_spec"
            ],
            "conditions": [
              "trigger = vague_spec"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Split complex task into smaller Units-of-Work",
            "actor": "system",
            "inputs": [
              "failed_task"
            ],
            "outputs": [
              "smaller_tasks"
            ],
            "conditions": [
              "trigger = task_too_large"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Propose new test or lint rule for early detection",
            "actor": "system",
            "inputs": [
              "trigger_category"
            ],
            "outputs": [
              "new_guardrail"
            ],
            "conditions": [
              "trigger = test_gap"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Update ADR.md with failure analysis and remediation",
            "actor": "system",
            "inputs": [
              "root_cause_report",
              "remediation_actions"
            ],
            "outputs": [
              "updated_ADR.md"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Signal ready for pipeline restart",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "restart_ready"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "activity.log and LAST_COMPILER_ERROR.log analyzed",
          "Trigger identified: vague spec, rule violation, or test gap",
          "Context fill status at failure time checked",
          "Specific problem file identified if token spike occurred",
          "Ambiguous spec logic clarified",
          "Complex task split into smaller Units-of-Work",
          "New test or lint rule proposed for early detection",
          "ADR.md updated with failure analysis"
        ],
        "error_handling": [
          {
            "error_condition": "Log files missing",
            "recovery_action": "Analyze from git diff and commit messages",
            "escalation": "Document incomplete forensics in ADR"
          },
          {
            "error_condition": "Root cause indeterminate",
            "recovery_action": "Flag for human review",
            "escalation": "Pause pipeline until human investigates"
          },
          {
            "error_condition": "Spec clarification requires human input",
            "recovery_action": "Generate clarifying questions",
            "escalation": "Wait for human response before restart"
          },
          {
            "error_condition": "ADR update fails",
            "recovery_action": "Store analysis in temp file",
            "escalation": "Manual ADR update required"
          }
        ]
      },
      {
        "id": "FLOW-018",
        "name": "Final Deployment and Client Handoff",
        "description": "End-of-project documentation and deployment automation using accumulated Shift Reports and ADR entries for production-ready handoff.",
        "feature_id": "FR-013",
        "story_ids": [
          "ST-042",
          "ST-043"
        ],
        "actor": "system",
        "trigger": "IMPLEMENTATION_PLAN.md shows 100% completion",
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Final Manager detects 100% roadmap completion",
            "actor": "system",
            "inputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "outputs": [
              "completion_confirmed"
            ],
            "conditions": [
              "all_tasks_checked"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Initiate Final Sanity Check audits",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "audit_job"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Global RipGrep for tenantId in all Prisma queries",
            "actor": "system",
            "inputs": [
              "prisma_files"
            ],
            "outputs": [
              "tenancy_audit_result"
            ],
            "conditions": [
              "all_queries_have_tenantId"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Verify Zod validation presence on all API endpoints",
            "actor": "system",
            "inputs": [
              "api_files"
            ],
            "outputs": [
              "validation_audit_result"
            ],
            "conditions": [
              "all_endpoints_validated"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Named export verification (no export default)",
            "actor": "system",
            "inputs": [
              "module_files"
            ],
            "outputs": [
              "export_audit_result"
            ],
            "conditions": [
              "no_default_exports"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "N+1 query detection in Service layer",
            "actor": "system",
            "inputs": [
              "service_files"
            ],
            "outputs": [
              "n_plus_one_audit_result"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Compile all SHIFT_REPORT.md files for synthesis",
            "actor": "system",
            "inputs": [
              "shift_reports_directory"
            ],
            "outputs": [
              "compiled_reports"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Extract key decisions from ADR.md",
            "actor": "system",
            "inputs": [
              "ADR.md"
            ],
            "outputs": [
              "key_decisions"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Confirm 100% feature coverage against PRD.md",
            "actor": "system",
            "inputs": [
              "PRD.md",
              "completed_features"
            ],
            "outputs": [
              "coverage_confirmation"
            ],
            "conditions": [
              "all_features_implemented"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Generate deployment instructions",
            "actor": "system",
            "inputs": [
              "project_config"
            ],
            "outputs": [
              "deployment_instructions"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Generate maintenance guidelines",
            "actor": "system",
            "inputs": [
              "ADR.md",
              "architecture_notes"
            ],
            "outputs": [
              "maintenance_guidelines"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Write README_CLIENT.md with professional handoff documentation",
            "actor": "system",
            "inputs": [
              "compiled_reports",
              "key_decisions",
              "deployment_instructions",
              "maintenance_guidelines"
            ],
            "outputs": [
              "README_CLIENT.md"
            ],
            "conditions": [],
            "next_steps": [
              "STEP-013"
            ]
          },
          {
            "id": "STEP-013",
            "sequence": 13,
            "action": "Final Manager exits with code 0 signaling project completion",
            "actor": "system",
            "inputs": [],
            "outputs": [
              "exit_code_0"
            ],
            "conditions": [],
            "next_steps": []
          }
        ],
        "success_criteria": [
          "Global RipGrep confirms tenantId in all Prisma queries",
          "Zod validation verified on all API endpoints",
          "Named export verification passed (no export default)",
          "N+1 query detection completed in Service layer",
          "All SHIFT_REPORT.md files synthesized",
          "Key decisions extracted from ADR.md",
          "100% feature coverage confirmed against PRD.md",
          "README_CLIENT.md includes deployment and maintenance instructions"
        ],
        "error_handling": [
          {
            "error_condition": "Multi-tenancy audit fails",
            "recovery_action": "Generate task to add missing tenantId",
            "escalation": "Block deployment until fixed"
          },
          {
            "error_condition": "Zod validation missing",
            "recovery_action": "Generate task to add validation",
            "escalation": "Block deployment until fixed"
          },
          {
            "error_condition": "Default exports found",
            "recovery_action": "Generate task to refactor exports",
            "escalation": "Block deployment until fixed"
          },
          {
            "error_condition": "Feature coverage incomplete",
            "recovery_action": "Identify missing features and add tasks",
            "escalation": "Return to implementation phase"
          }
        ]
      }
    ],
    "system_flows": [
      {
        "id": "SFLOW-001",
        "name": "Main Pipeline Flow",
        "description": "Complete end-to-end flow from brainstorm intake through autonomous implementation to production deployment.",
        "components": [
          "distiller",
          "orchestrator",
          "shift_manager",
          "worker",
          "guardrails",
          "dashboard",
          "watcher"
        ],
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Brainstorm Intake Phase",
            "component": "distiller",
            "inputs": [
              "raw_brainstorm.txt"
            ],
            "outputs": [
              "specs/PRD.md",
              "specs/index.md",
              "IMPLEMENTATION_PLAN.md"
            ],
            "data_flow": [
              "filesystem_read",
              "ai_processing",
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Orchestrator Initialization",
            "component": "orchestrator",
            "inputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "outputs": [
              "orchestrator_process"
            ],
            "data_flow": [
              "process_spawn",
              "state_initialization"
            ],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Watcher Server Startup",
            "component": "watcher",
            "inputs": [
              "server_config"
            ],
            "outputs": [
              "http_server",
              "websocket_server",
              "file_watchers"
            ],
            "data_flow": [
              "tcp_bind",
              "filesystem_watch"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Shift Manager Spawn",
            "component": "orchestrator",
            "inputs": [
              "SHIFT_HANDOFF.md (if exists)"
            ],
            "outputs": [
              "manager_process"
            ],
            "data_flow": [
              "process_spawn",
              "context_injection"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Task Selection and Worker Assignment",
            "component": "shift_manager",
            "inputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "outputs": [
              "current_task.md",
              "worker_spawn_signal"
            ],
            "data_flow": [
              "filesystem_read",
              "filesystem_write",
              "ipc_signal"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Worker Spawn and Execution",
            "component": "worker",
            "inputs": [
              "current_task.md",
              "PRD.md"
            ],
            "outputs": [
              "code_changes",
              "status_fragment.md"
            ],
            "data_flow": [
              "process_spawn",
              "ralph_loop",
              "git_commit"
            ],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Guardrail Verification",
            "component": "guardrails",
            "inputs": [
              "staged_changes"
            ],
            "outputs": [
              "verification_result"
            ],
            "data_flow": [
              "compiler_check",
              "test_run",
              "lint_audit"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Telemetry Update",
            "component": "watcher",
            "inputs": [
              "telemetry.json changes"
            ],
            "outputs": [
              "websocket_broadcast"
            ],
            "data_flow": [
              "filesystem_watch",
              "json_parse",
              "socket_emit"
            ],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Dashboard UI Update",
            "component": "dashboard",
            "inputs": [
              "websocket_event"
            ],
            "outputs": [
              "ui_render"
            ],
            "data_flow": [
              "socket_receive",
              "dom_update"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "ADR Logging",
            "component": "shift_manager",
            "inputs": [
              "status_fragment.md"
            ],
            "outputs": [
              "ADR.md entry"
            ],
            "data_flow": [
              "filesystem_read",
              "filesystem_append"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Context Threshold Check",
            "component": "shift_manager",
            "inputs": [
              "token_count"
            ],
            "outputs": [
              "continue OR rotate OR complete"
            ],
            "data_flow": [
              "internal_calculation"
            ],
            "next_steps": [
              "STEP-005",
              "STEP-012",
              "STEP-013"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Shift Rotation",
            "component": "orchestrator",
            "inputs": [
              "exit_code_10",
              "SHIFT_HANDOFF.md"
            ],
            "outputs": [
              "new_manager_spawn"
            ],
            "data_flow": [
              "process_kill",
              "process_spawn"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-013",
            "sequence": 13,
            "action": "Final Deployment and Handoff",
            "component": "shift_manager",
            "inputs": [
              "100% completion"
            ],
            "outputs": [
              "README_CLIENT.md",
              "exit_code_0"
            ],
            "data_flow": [
              "filesystem_read",
              "filesystem_write"
            ],
            "next_steps": []
          }
        ],
        "data_flow": [
          {
            "source": "distiller",
            "target": "filesystem",
            "data": "specs and plan files",
            "protocol": "filesystem"
          },
          {
            "source": "orchestrator",
            "target": "shift_manager",
            "data": "spawn signal and handoff",
            "protocol": "process_spawn"
          },
          {
            "source": "shift_manager",
            "target": "worker",
            "data": "task context",
            "protocol": "process_spawn"
          },
          {
            "source": "worker",
            "target": "guardrails",
            "data": "code changes",
            "protocol": "subprocess"
          },
          {
            "source": "filesystem",
            "target": "watcher",
            "data": "file change events",
            "protocol": "fs.watch"
          },
          {
            "source": "watcher",
            "target": "dashboard",
            "data": "telemetry and progress",
            "protocol": "websocket"
          }
        ],
        "error_handling": [
          {
            "component": "orchestrator",
            "error": "manager_crash",
            "recovery": "retry with 5s delay, max 3 attempts"
          },
          {
            "component": "worker",
            "error": "ralph_loop_timeout",
            "recovery": "kill and spawn fresh worker"
          },
          {
            "component": "guardrails",
            "error": "verification_fail",
            "recovery": "block commit, return to edit step"
          },
          {
            "component": "watcher",
            "error": "socket_disconnect",
            "recovery": "client auto-reconnect"
          }
        ]
      },
      {
        "id": "SFLOW-002",
        "name": "Distiller Processing Pipeline",
        "description": "System flow for converting raw brainstorms into structured specifications through AI-driven analysis.",
        "components": [
          "cli",
          "distiller_agent",
          "ripgrep",
          "filesystem",
          "ai_model"
        ],
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "CLI receives /...seed command",
            "component": "cli",
            "inputs": [
              "command_string",
              "file_reference"
            ],
            "outputs": [
              "distiller_trigger"
            ],
            "data_flow": [
              "command_parse"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Load brainstorm file from filesystem",
            "component": "filesystem",
            "inputs": [
              "file_path"
            ],
            "outputs": [
              "raw_content"
            ],
            "data_flow": [
              "filesystem_read"
            ],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Voice separation analysis",
            "component": "distiller_agent",
            "inputs": [
              "raw_content"
            ],
            "outputs": [
              "voice_of_client",
              "voice_of_engineer"
            ],
            "data_flow": [
              "ai_processing"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Execute RipGrep pattern analysis (min 15 searches)",
            "component": "ripgrep",
            "inputs": [
              "codebase",
              "search_patterns"
            ],
            "outputs": [
              "pattern_matches",
              "keyword_map"
            ],
            "data_flow": [
              "subprocess_exec"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Extract functional requirements",
            "component": "distiller_agent",
            "inputs": [
              "voice_of_client",
              "pattern_matches"
            ],
            "outputs": [
              "requirements_list"
            ],
            "data_flow": [
              "ai_processing"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Generate PRD structure",
            "component": "distiller_agent",
            "inputs": [
              "requirements_list",
              "constraints"
            ],
            "outputs": [
              "prd_structure"
            ],
            "data_flow": [
              "ai_processing"
            ],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Write specs/PRD.md",
            "component": "filesystem",
            "inputs": [
              "prd_structure"
            ],
            "outputs": [
              "specs/PRD.md"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Generate keyword-rich index",
            "component": "distiller_agent",
            "inputs": [
              "prd_structure",
              "keyword_map"
            ],
            "outputs": [
              "index_structure"
            ],
            "data_flow": [
              "ai_processing"
            ],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Write specs/index.md (PIN)",
            "component": "filesystem",
            "inputs": [
              "index_structure"
            ],
            "outputs": [
              "specs/index.md"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Dependency analysis for task ordering",
            "component": "distiller_agent",
            "inputs": [
              "requirements_list"
            ],
            "outputs": [
              "dependency_graph"
            ],
            "data_flow": [
              "ai_processing"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Atomic task breakdown",
            "component": "distiller_agent",
            "inputs": [
              "dependency_graph"
            ],
            "outputs": [
              "atomic_tasks"
            ],
            "data_flow": [
              "ai_processing"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Write IMPLEMENTATION_PLAN.md",
            "component": "filesystem",
            "inputs": [
              "atomic_tasks"
            ],
            "outputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-013"
            ]
          },
          {
            "id": "STEP-013",
            "sequence": 13,
            "action": "Output success status to CLI",
            "component": "cli",
            "inputs": [
              "generation_result"
            ],
            "outputs": [
              "status_message"
            ],
            "data_flow": [
              "stdout"
            ],
            "next_steps": []
          }
        ],
        "data_flow": [
          {
            "source": "cli",
            "target": "filesystem",
            "data": "file reference",
            "protocol": "argument_pass"
          },
          {
            "source": "filesystem",
            "target": "distiller_agent",
            "data": "raw_content",
            "protocol": "memory_buffer"
          },
          {
            "source": "distiller_agent",
            "target": "ripgrep",
            "data": "search_queries",
            "protocol": "subprocess"
          },
          {
            "source": "distiller_agent",
            "target": "ai_model",
            "data": "prompts",
            "protocol": "api_call"
          },
          {
            "source": "distiller_agent",
            "target": "filesystem",
            "data": "generated_files",
            "protocol": "filesystem_write"
          }
        ],
        "error_handling": [
          {
            "component": "filesystem",
            "error": "file_not_found",
            "recovery": "display error with expected path"
          },
          {
            "component": "ripgrep",
            "error": "no_patterns_found",
            "recovery": "continue with minimal pattern context"
          },
          {
            "component": "distiller_agent",
            "error": "ai_timeout",
            "recovery": "retry with exponential backoff"
          },
          {
            "component": "filesystem",
            "error": "write_permission_denied",
            "recovery": "attempt elevated permissions or alternate path"
          }
        ]
      },
      {
        "id": "SFLOW-003",
        "name": "Manager-Worker Communication Flow",
        "description": "System flow for task assignment, monitoring, and result collection between Shift Manager and Worker agents.",
        "components": [
          "shift_manager",
          "orchestrator",
          "worker",
          "filesystem",
          "telemetry"
        ],
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Manager reads next task from IMPLEMENTATION_PLAN.md",
            "component": "shift_manager",
            "inputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "outputs": [
              "next_task_id",
              "task_details"
            ],
            "data_flow": [
              "filesystem_read",
              "regex_parse"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Manager prepares minimal context package",
            "component": "shift_manager",
            "inputs": [
              "task_details",
              "PRD_reference"
            ],
            "outputs": [
              "context_package"
            ],
            "data_flow": [
              "memory_composition"
            ],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Manager writes current_task.md",
            "component": "filesystem",
            "inputs": [
              "context_package"
            ],
            "outputs": [
              ".agent/current_task.md"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Manager signals Orchestrator to spawn Worker",
            "component": "shift_manager",
            "inputs": [],
            "outputs": [
              "spawn_signal"
            ],
            "data_flow": [
              "exit_code_signal"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Orchestrator spawns fresh Claude Code instance",
            "component": "orchestrator",
            "inputs": [
              "spawn_signal"
            ],
            "outputs": [
              "worker_pid",
              "worker_process"
            ],
            "data_flow": [
              "process_fork",
              "env_setup"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Worker reads current_task.md",
            "component": "worker",
            "inputs": [
              ".agent/current_task.md"
            ],
            "outputs": [
              "task_understanding"
            ],
            "data_flow": [
              "filesystem_read"
            ],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Worker executes Ralph Wiggum Loop",
            "component": "worker",
            "inputs": [
              "task_understanding"
            ],
            "outputs": [
              "code_changes",
              "commit_hash"
            ],
            "data_flow": [
              "edit_compile_test_loop"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Worker writes status_fragment.md",
            "component": "filesystem",
            "inputs": [
              "completion_summary"
            ],
            "outputs": [
              ".agent/status_fragment.md"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Worker terminates with exit code",
            "component": "worker",
            "inputs": [],
            "outputs": [
              "exit_code"
            ],
            "data_flow": [
              "process_exit"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Orchestrator captures exit code and cleans up",
            "component": "orchestrator",
            "inputs": [
              "exit_code"
            ],
            "outputs": [
              "cleanup_complete"
            ],
            "data_flow": [
              "process_reap",
              "memory_free"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Orchestrator resets telemetry to 0%",
            "component": "telemetry",
            "inputs": [],
            "outputs": [
              "telemetry.json updated"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Manager reads status_fragment.md",
            "component": "shift_manager",
            "inputs": [
              ".agent/status_fragment.md"
            ],
            "outputs": [
              "worker_decisions"
            ],
            "data_flow": [
              "filesystem_read"
            ],
            "next_steps": [
              "STEP-013"
            ]
          },
          {
            "id": "STEP-013",
            "sequence": 13,
            "action": "Manager updates IMPLEMENTATION_PLAN.md checkbox",
            "component": "filesystem",
            "inputs": [
              "task_id",
              "completion_status"
            ],
            "outputs": [
              "IMPLEMENTATION_PLAN.md updated"
            ],
            "data_flow": [
              "filesystem_read_modify_write"
            ],
            "next_steps": [
              "STEP-014"
            ]
          },
          {
            "id": "STEP-014",
            "sequence": 14,
            "action": "Manager appends to ADR.md",
            "component": "filesystem",
            "inputs": [
              "worker_decisions",
              "commit_hash"
            ],
            "outputs": [
              "ADR.md updated"
            ],
            "data_flow": [
              "filesystem_append"
            ],
            "next_steps": []
          }
        ],
        "data_flow": [
          {
            "source": "shift_manager",
            "target": "filesystem",
            "data": "task context file",
            "protocol": "filesystem_write"
          },
          {
            "source": "shift_manager",
            "target": "orchestrator",
            "data": "spawn request",
            "protocol": "exit_code_signal"
          },
          {
            "source": "orchestrator",
            "target": "worker",
            "data": "process spawn",
            "protocol": "process_fork"
          },
          {
            "source": "worker",
            "target": "filesystem",
            "data": "status fragment",
            "protocol": "filesystem_write"
          },
          {
            "source": "filesystem",
            "target": "shift_manager",
            "data": "worker output",
            "protocol": "filesystem_read"
          }
        ],
        "error_handling": [
          {
            "component": "orchestrator",
            "error": "worker_spawn_fail",
            "recovery": "retry spawn with 5s delay"
          },
          {
            "component": "worker",
            "error": "task_timeout",
            "recovery": "force kill and log timeout"
          },
          {
            "component": "filesystem",
            "error": "status_fragment_missing",
            "recovery": "generate minimal ADR from git log"
          },
          {
            "component": "shift_manager",
            "error": "plan_update_conflict",
            "recovery": "retry with file locking"
          }
        ]
      },
      {
        "id": "SFLOW-004",
        "name": "Ralph Wiggum Loop - Edit Build Test Cycle",
        "description": "Internal Worker execution loop that iterates through code editing, compilation, and testing until success or max retries.",
        "components": [
          "worker",
          "editor",
          "compiler",
          "test_runner",
          "git",
          "filesystem"
        ],
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Worker analyzes task and identifies target files",
            "component": "worker",
            "inputs": [
              "current_task.md"
            ],
            "outputs": [
              "file_targets",
              "edit_plan"
            ],
            "data_flow": [
              "ai_reasoning"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Check for LAST_COMPILER_ERROR.log",
            "component": "filesystem",
            "inputs": [
              ".agent/LAST_COMPILER_ERROR.log"
            ],
            "outputs": [
              "previous_error_context"
            ],
            "data_flow": [
              "filesystem_read"
            ],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "EDIT: Worker applies code changes",
            "component": "editor",
            "inputs": [
              "edit_plan",
              "target_files"
            ],
            "outputs": [
              "modified_files"
            ],
            "data_flow": [
              "filesystem_modify"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "BUILD: Run TypeScript compiler (tsc)",
            "component": "compiler",
            "inputs": [
              "modified_files"
            ],
            "outputs": [
              "compiler_output",
              "exit_code"
            ],
            "data_flow": [
              "subprocess_exec"
            ],
            "next_steps": [
              "STEP-005",
              "STEP-007"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "BUILD FAILED: Capture error to LAST_COMPILER_ERROR.log",
            "component": "filesystem",
            "inputs": [
              "compiler_output"
            ],
            "outputs": [
              "LAST_COMPILER_ERROR.log"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Increment retry counter and check limit",
            "component": "worker",
            "inputs": [
              "retry_count"
            ],
            "outputs": [
              "continue_or_escalate"
            ],
            "data_flow": [
              "internal_counter"
            ],
            "next_steps": [
              "STEP-003",
              "STEP-013"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "BUILD SUCCESS: Proceed to testing",
            "component": "compiler",
            "inputs": [
              "exit_code = 0"
            ],
            "outputs": [
              "build_success_signal"
            ],
            "data_flow": [
              "signal"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "TEST: Run unit test suite",
            "component": "test_runner",
            "inputs": [
              "compiled_code"
            ],
            "outputs": [
              "test_output",
              "coverage_report",
              "exit_code"
            ],
            "data_flow": [
              "subprocess_exec"
            ],
            "next_steps": [
              "STEP-009",
              "STEP-011"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "TEST FAILED: Analyze test output for fix",
            "component": "worker",
            "inputs": [
              "test_output"
            ],
            "outputs": [
              "fix_analysis"
            ],
            "data_flow": [
              "ai_reasoning"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Increment retry and return to EDIT",
            "component": "worker",
            "inputs": [
              "retry_count",
              "fix_analysis"
            ],
            "outputs": [
              "continue_or_escalate"
            ],
            "data_flow": [
              "internal_counter"
            ],
            "next_steps": [
              "STEP-003",
              "STEP-013"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "TEST SUCCESS: All tests pass",
            "component": "test_runner",
            "inputs": [
              "exit_code = 0"
            ],
            "outputs": [
              "test_success_signal"
            ],
            "data_flow": [
              "signal"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "COMMIT: Stage and commit changes",
            "component": "git",
            "inputs": [
              "modified_files",
              "task_id"
            ],
            "outputs": [
              "commit_hash"
            ],
            "data_flow": [
              "git_add",
              "git_commit"
            ],
            "next_steps": [
              "STEP-014"
            ]
          },
          {
            "id": "STEP-013",
            "sequence": 13,
            "action": "MAX RETRIES: Escalate to Manager",
            "component": "worker",
            "inputs": [
              "retry_count = 5"
            ],
            "outputs": [
              "escalation_signal"
            ],
            "data_flow": [
              "exit_code_signal"
            ],
            "next_steps": [
              "STEP-015"
            ]
          },
          {
            "id": "STEP-014",
            "sequence": 14,
            "action": "Clear LAST_COMPILER_ERROR.log on success",
            "component": "filesystem",
            "inputs": [],
            "outputs": [
              "cleared_log"
            ],
            "data_flow": [
              "filesystem_delete"
            ],
            "next_steps": [
              "STEP-015"
            ]
          },
          {
            "id": "STEP-015",
            "sequence": 15,
            "action": "Exit Ralph Loop",
            "component": "worker",
            "inputs": [
              "loop_result"
            ],
            "outputs": [
              "success_or_failure"
            ],
            "data_flow": [
              "loop_exit"
            ],
            "next_steps": []
          }
        ],
        "data_flow": [
          {
            "source": "worker",
            "target": "editor",
            "data": "edit commands",
            "protocol": "tool_call"
          },
          {
            "source": "editor",
            "target": "compiler",
            "data": "modified source",
            "protocol": "filesystem"
          },
          {
            "source": "compiler",
            "target": "test_runner",
            "data": "compiled artifacts",
            "protocol": "filesystem"
          },
          {
            "source": "test_runner",
            "target": "git",
            "data": "verified changes",
            "protocol": "success_signal"
          },
          {
            "source": "compiler",
            "target": "filesystem",
            "data": "error output",
            "protocol": "filesystem_write"
          }
        ],
        "error_handling": [
          {
            "component": "compiler",
            "error": "compiler_crash",
            "recovery": "log error and terminate loop"
          },
          {
            "component": "test_runner",
            "error": "test_runner_unavailable",
            "recovery": "skip tests and warn (not recommended)"
          },
          {
            "component": "git",
            "error": "commit_conflict",
            "recovery": "rebase and retry commit"
          },
          {
            "component": "worker",
            "error": "context_overflow",
            "recovery": "terminate and spawn fresh worker"
          }
        ]
      },
      {
        "id": "SFLOW-005",
        "name": "Dashboard Data Flow",
        "description": "Real-time data pipeline from file changes through WebSocket to browser UI updates.",
        "components": [
          "filesystem",
          "watcher",
          "socket_io",
          "express",
          "browser",
          "dashboard_ui"
        ],
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Agent writes to telemetry.json",
            "component": "filesystem",
            "inputs": [
              "context_percent",
              "status"
            ],
            "outputs": [
              ".ralph/telemetry.json"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "fs.watch detects file change event",
            "component": "watcher",
            "inputs": [
              "file_change_event"
            ],
            "outputs": [
              "change_notification"
            ],
            "data_flow": [
              "inotify_event"
            ],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Watcher reads and parses telemetry.json",
            "component": "watcher",
            "inputs": [
              ".ralph/telemetry.json"
            ],
            "outputs": [
              "telemetry_object"
            ],
            "data_flow": [
              "filesystem_read",
              "json_parse"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Socket.io emits 'telemetry' event to all clients",
            "component": "socket_io",
            "inputs": [
              "telemetry_object"
            ],
            "outputs": [
              "broadcast_event"
            ],
            "data_flow": [
              "websocket_emit"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Browser receives 'telemetry' event",
            "component": "browser",
            "inputs": [
              "websocket_message"
            ],
            "outputs": [
              "telemetry_data"
            ],
            "data_flow": [
              "websocket_receive"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Dashboard updates context progress bars",
            "component": "dashboard_ui",
            "inputs": [
              "telemetry_data"
            ],
            "outputs": [
              "dom_update"
            ],
            "data_flow": [
              "javascript_render"
            ],
            "next_steps": []
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Agent marks task complete in IMPLEMENTATION_PLAN.md",
            "component": "filesystem",
            "inputs": [
              "task_completion"
            ],
            "outputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "fs.watchFile detects roadmap change",
            "component": "watcher",
            "inputs": [
              "file_stat_change"
            ],
            "outputs": [
              "roadmap_notification"
            ],
            "data_flow": [
              "polling_detect"
            ],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Watcher counts [x] vs [ ] checkboxes",
            "component": "watcher",
            "inputs": [
              "IMPLEMENTATION_PLAN.md"
            ],
            "outputs": [
              "completed_count",
              "total_count"
            ],
            "data_flow": [
              "filesystem_read",
              "regex_count"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Socket.io emits 'roadmap' event with progress",
            "component": "socket_io",
            "inputs": [
              "progress_data"
            ],
            "outputs": [
              "broadcast_event"
            ],
            "data_flow": [
              "websocket_emit"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Browser receives 'roadmap' event",
            "component": "browser",
            "inputs": [
              "websocket_message"
            ],
            "outputs": [
              "progress_data"
            ],
            "data_flow": [
              "websocket_receive"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Dashboard updates progress visualization",
            "component": "dashboard_ui",
            "inputs": [
              "progress_data"
            ],
            "outputs": [
              "dom_update"
            ],
            "data_flow": [
              "javascript_render"
            ],
            "next_steps": []
          }
        ],
        "data_flow": [
          {
            "source": "agent_process",
            "target": "filesystem",
            "data": "telemetry JSON",
            "protocol": "filesystem_write"
          },
          {
            "source": "filesystem",
            "target": "watcher",
            "data": "change event",
            "protocol": "fs.watch"
          },
          {
            "source": "watcher",
            "target": "socket_io",
            "data": "parsed data",
            "protocol": "function_call"
          },
          {
            "source": "socket_io",
            "target": "browser",
            "data": "event payload",
            "protocol": "websocket"
          },
          {
            "source": "browser",
            "target": "dashboard_ui",
            "data": "state update",
            "protocol": "javascript"
          }
        ],
        "error_handling": [
          {
            "component": "watcher",
            "error": "partial_json_write",
            "recovery": "wait 50ms and retry parse"
          },
          {
            "component": "watcher",
            "error": "file_watcher_fail",
            "recovery": "re-initialize watcher"
          },
          {
            "component": "socket_io",
            "error": "client_disconnect",
            "recovery": "clean up client state"
          },
          {
            "component": "browser",
            "error": "connection_lost",
            "recovery": "auto-reconnect with backoff"
          }
        ]
      },
      {
        "id": "SFLOW-006",
        "name": "Crisis Mode System Flow",
        "description": "Emergency override flow from button click through process termination, code revert, and telemetry reset.",
        "components": [
          "dashboard_ui",
          "browser",
          "socket_io",
          "watcher",
          "process_manager",
          "git",
          "filesystem"
        ],
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "User clicks Crisis Mode button",
            "component": "dashboard_ui",
            "inputs": [
              "click_event"
            ],
            "outputs": [
              "crisis_trigger"
            ],
            "data_flow": [
              "dom_event"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Dashboard shows immediate visual feedback",
            "component": "dashboard_ui",
            "inputs": [
              "crisis_trigger"
            ],
            "outputs": [
              "visual_confirmation"
            ],
            "data_flow": [
              "css_animation"
            ],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Browser emits 'crisis' event via WebSocket",
            "component": "browser",
            "inputs": [
              "crisis_trigger"
            ],
            "outputs": [
              "websocket_message"
            ],
            "data_flow": [
              "websocket_emit"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Watcher receives 'crisis' event",
            "component": "watcher",
            "inputs": [
              "websocket_message"
            ],
            "outputs": [
              "crisis_signal"
            ],
            "data_flow": [
              "websocket_receive"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Execute pkill -f orchestrate.sh",
            "component": "process_manager",
            "inputs": [
              "kill_command"
            ],
            "outputs": [
              "orchestrator_terminated"
            ],
            "data_flow": [
              "subprocess_exec"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Execute pkill -f claude-code",
            "component": "process_manager",
            "inputs": [
              "kill_command"
            ],
            "outputs": [
              "ai_processes_terminated"
            ],
            "data_flow": [
              "subprocess_exec"
            ],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Log termination events to crisis.log",
            "component": "filesystem",
            "inputs": [
              "termination_results"
            ],
            "outputs": [
              "crisis.log"
            ],
            "data_flow": [
              "filesystem_append"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Execute git reset --hard HEAD",
            "component": "git",
            "inputs": [
              "reset_command"
            ],
            "outputs": [
              "code_reverted"
            ],
            "data_flow": [
              "subprocess_exec"
            ],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Git history preserved for forensics",
            "component": "git",
            "inputs": [],
            "outputs": [
              "history_intact"
            ],
            "data_flow": [
              "git_log"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Reset telemetry.json to zero state",
            "component": "filesystem",
            "inputs": [
              "reset_template"
            ],
            "outputs": [
              ".ralph/telemetry.json"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Watcher broadcasts 'crisis_complete' event",
            "component": "socket_io",
            "inputs": [
              "completion_status"
            ],
            "outputs": [
              "broadcast_event"
            ],
            "data_flow": [
              "websocket_emit"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "All connected dashboards receive update",
            "component": "browser",
            "inputs": [
              "websocket_message"
            ],
            "outputs": [
              "crisis_acknowledged"
            ],
            "data_flow": [
              "websocket_receive"
            ],
            "next_steps": [
              "STEP-013"
            ]
          },
          {
            "id": "STEP-013",
            "sequence": 13,
            "action": "Dashboard resets all progress bars to zero",
            "component": "dashboard_ui",
            "inputs": [
              "crisis_acknowledged"
            ],
            "outputs": [
              "ui_reset"
            ],
            "data_flow": [
              "dom_update"
            ],
            "next_steps": [
              "STEP-014"
            ]
          },
          {
            "id": "STEP-014",
            "sequence": 14,
            "action": "System ready for loop restart",
            "component": "watcher",
            "inputs": [],
            "outputs": [
              "ready_state"
            ],
            "data_flow": [
              "state_set"
            ],
            "next_steps": []
          }
        ],
        "data_flow": [
          {
            "source": "dashboard_ui",
            "target": "browser",
            "data": "crisis trigger",
            "protocol": "dom_event"
          },
          {
            "source": "browser",
            "target": "watcher",
            "data": "crisis signal",
            "protocol": "websocket"
          },
          {
            "source": "watcher",
            "target": "process_manager",
            "data": "kill commands",
            "protocol": "subprocess"
          },
          {
            "source": "process_manager",
            "target": "git",
            "data": "reset trigger",
            "protocol": "subprocess"
          },
          {
            "source": "watcher",
            "target": "filesystem",
            "data": "telemetry reset",
            "protocol": "filesystem_write"
          },
          {
            "source": "watcher",
            "target": "browser",
            "data": "completion broadcast",
            "protocol": "websocket"
          }
        ],
        "error_handling": [
          {
            "component": "process_manager",
            "error": "process_not_found",
            "recovery": "log and continue (already dead)"
          },
          {
            "component": "process_manager",
            "error": "kill_permission_denied",
            "recovery": "escalate to SIGKILL"
          },
          {
            "component": "git",
            "error": "reset_failed",
            "recovery": "attempt git clean -fd"
          },
          {
            "component": "socket_io",
            "error": "broadcast_failed",
            "recovery": "retry broadcast after 100ms"
          }
        ]
      },
      {
        "id": "SFLOW-007",
        "name": "File Watcher Event Chain",
        "description": "Low-level system flow for filesystem monitoring and event propagation from agent writes to UI updates.",
        "components": [
          "agent",
          "filesystem",
          "inotify",
          "watcher_process",
          "event_emitter",
          "socket_io",
          "browser"
        ],
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Agent opens file for writing",
            "component": "agent",
            "inputs": [
              "file_path",
              "content"
            ],
            "outputs": [
              "file_descriptor"
            ],
            "data_flow": [
              "syscall_open"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Agent writes content to file",
            "component": "filesystem",
            "inputs": [
              "file_descriptor",
              "content"
            ],
            "outputs": [
              "bytes_written"
            ],
            "data_flow": [
              "syscall_write"
            ],
            "next_steps": [
              "STEP-003"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "Agent closes file descriptor",
            "component": "agent",
            "inputs": [
              "file_descriptor"
            ],
            "outputs": [
              "close_complete"
            ],
            "data_flow": [
              "syscall_close"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Kernel emits inotify IN_CLOSE_WRITE event",
            "component": "inotify",
            "inputs": [
              "file_change"
            ],
            "outputs": [
              "inotify_event"
            ],
            "data_flow": [
              "kernel_event"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Node.js fs.watch callback triggered",
            "component": "watcher_process",
            "inputs": [
              "inotify_event"
            ],
            "outputs": [
              "watch_callback"
            ],
            "data_flow": [
              "libuv_event"
            ],
            "next_steps": [
              "STEP-006"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Watcher debounces rapid changes (50ms)",
            "component": "watcher_process",
            "inputs": [
              "watch_callback"
            ],
            "outputs": [
              "debounced_event"
            ],
            "data_flow": [
              "timeout_set"
            ],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "Watcher reads file content",
            "component": "filesystem",
            "inputs": [
              "file_path"
            ],
            "outputs": [
              "file_content"
            ],
            "data_flow": [
              "syscall_read"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Watcher validates JSON syntax",
            "component": "watcher_process",
            "inputs": [
              "file_content"
            ],
            "outputs": [
              "parsed_json OR parse_error"
            ],
            "data_flow": [
              "json_parse"
            ],
            "next_steps": [
              "STEP-009",
              "STEP-010"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "If parse error: Wait and retry",
            "component": "watcher_process",
            "inputs": [
              "parse_error"
            ],
            "outputs": [
              "retry_scheduled"
            ],
            "data_flow": [
              "timeout_set"
            ],
            "next_steps": [
              "STEP-007"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Watcher emits internal event",
            "component": "event_emitter",
            "inputs": [
              "parsed_json"
            ],
            "outputs": [
              "internal_event"
            ],
            "data_flow": [
              "eventemitter_emit"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Socket.io broadcasts to connected clients",
            "component": "socket_io",
            "inputs": [
              "internal_event"
            ],
            "outputs": [
              "websocket_frames"
            ],
            "data_flow": [
              "socket_broadcast"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Browser receives WebSocket message",
            "component": "browser",
            "inputs": [
              "websocket_frame"
            ],
            "outputs": [
              "javascript_event"
            ],
            "data_flow": [
              "websocket_onmessage"
            ],
            "next_steps": [
              "STEP-013"
            ]
          },
          {
            "id": "STEP-013",
            "sequence": 13,
            "action": "JavaScript updates DOM",
            "component": "browser",
            "inputs": [
              "javascript_event"
            ],
            "outputs": [
              "dom_mutation"
            ],
            "data_flow": [
              "dom_api"
            ],
            "next_steps": []
          }
        ],
        "data_flow": [
          {
            "source": "agent",
            "target": "filesystem",
            "data": "file content",
            "protocol": "syscall"
          },
          {
            "source": "filesystem",
            "target": "inotify",
            "data": "change event",
            "protocol": "kernel_notification"
          },
          {
            "source": "inotify",
            "target": "watcher_process",
            "data": "event descriptor",
            "protocol": "libuv"
          },
          {
            "source": "watcher_process",
            "target": "socket_io",
            "data": "parsed data",
            "protocol": "function_call"
          },
          {
            "source": "socket_io",
            "target": "browser",
            "data": "JSON payload",
            "protocol": "websocket"
          }
        ],
        "error_handling": [
          {
            "component": "inotify",
            "error": "watch_limit_exceeded",
            "recovery": "fall back to polling"
          },
          {
            "component": "watcher_process",
            "error": "json_parse_error",
            "recovery": "retry after 50ms debounce"
          },
          {
            "component": "socket_io",
            "error": "socket_error",
            "recovery": "reconnect with backoff"
          },
          {
            "component": "browser",
            "error": "websocket_close",
            "recovery": "auto-reconnect"
          }
        ]
      },
      {
        "id": "SFLOW-008",
        "name": "Error Recovery Chain",
        "description": "System flow for handling errors across the pipeline including retries, escalation, and recovery procedures.",
        "components": [
          "orchestrator",
          "shift_manager",
          "worker",
          "guardrails",
          "filesystem",
          "telemetry"
        ],
        "steps": [
          {
            "id": "STEP-001",
            "sequence": 1,
            "action": "Error detected in pipeline component",
            "component": "orchestrator",
            "inputs": [
              "error_signal",
              "exit_code"
            ],
            "outputs": [
              "error_classification"
            ],
            "data_flow": [
              "signal_capture"
            ],
            "next_steps": [
              "STEP-002"
            ]
          },
          {
            "id": "STEP-002",
            "sequence": 2,
            "action": "Classify error type: transient vs persistent",
            "component": "orchestrator",
            "inputs": [
              "error_classification"
            ],
            "outputs": [
              "recovery_strategy"
            ],
            "data_flow": [
              "decision_logic"
            ],
            "next_steps": [
              "STEP-003",
              "STEP-007"
            ]
          },
          {
            "id": "STEP-003",
            "sequence": 3,
            "action": "TRANSIENT: Implement 5-second sleep delay",
            "component": "orchestrator",
            "inputs": [
              "recovery_strategy = retry"
            ],
            "outputs": [
              "delay_complete"
            ],
            "data_flow": [
              "sleep"
            ],
            "next_steps": [
              "STEP-004"
            ]
          },
          {
            "id": "STEP-004",
            "sequence": 4,
            "action": "Increment retry counter",
            "component": "orchestrator",
            "inputs": [
              "retry_count"
            ],
            "outputs": [
              "new_retry_count"
            ],
            "data_flow": [
              "counter_increment"
            ],
            "next_steps": [
              "STEP-005"
            ]
          },
          {
            "id": "STEP-005",
            "sequence": 5,
            "action": "Check if retry limit reached (max 3)",
            "component": "orchestrator",
            "inputs": [
              "new_retry_count"
            ],
            "outputs": [
              "can_retry OR escalate"
            ],
            "data_flow": [
              "comparison"
            ],
            "next_steps": [
              "STEP-006",
              "STEP-007"
            ]
          },
          {
            "id": "STEP-006",
            "sequence": 6,
            "action": "Restart failed component",
            "component": "orchestrator",
            "inputs": [
              "component_id",
              "restart_args"
            ],
            "outputs": [
              "new_process"
            ],
            "data_flow": [
              "process_spawn"
            ],
            "next_steps": [
              "STEP-012"
            ]
          },
          {
            "id": "STEP-007",
            "sequence": 7,
            "action": "PERSISTENT: Log crash information",
            "component": "filesystem",
            "inputs": [
              "error_details",
              "stack_trace"
            ],
            "outputs": [
              "crash.log"
            ],
            "data_flow": [
              "filesystem_append"
            ],
            "next_steps": [
              "STEP-008"
            ]
          },
          {
            "id": "STEP-008",
            "sequence": 8,
            "action": "Capture last known good state",
            "component": "filesystem",
            "inputs": [
              "IMPLEMENTATION_PLAN.md",
              "ADR.md"
            ],
            "outputs": [
              "state_snapshot"
            ],
            "data_flow": [
              "filesystem_read"
            ],
            "next_steps": [
              "STEP-009"
            ]
          },
          {
            "id": "STEP-009",
            "sequence": 9,
            "action": "Update telemetry with error status",
            "component": "telemetry",
            "inputs": [
              "error_status"
            ],
            "outputs": [
              "telemetry.json updated"
            ],
            "data_flow": [
              "filesystem_write"
            ],
            "next_steps": [
              "STEP-010"
            ]
          },
          {
            "id": "STEP-010",
            "sequence": 10,
            "action": "Broadcast error to dashboard",
            "component": "telemetry",
            "inputs": [
              "error_notification"
            ],
            "outputs": [
              "websocket_broadcast"
            ],
            "data_flow": [
              "socket_emit"
            ],
            "next_steps": [
              "STEP-011"
            ]
          },
          {
            "id": "STEP-011",
            "sequence": 11,
            "action": "Halt pipeline and await intervention",
            "component": "orchestrator",
            "inputs": [
              "halt_signal"
            ],
            "outputs": [
              "pipeline_halted"
            ],
            "data_flow": [
              "state_set"
            ],
            "next_steps": []
          },
          {
            "id": "STEP-012",
            "sequence": 12,
            "action": "Reset retry counter on success",
            "component": "orchestrator",
            "inputs": [
              "success_signal"
            ],
            "outputs": [
              "retry_count = 0"
            ],
            "data_flow": [
              "counter_reset"
            ],
            "next_steps": []
          }
        ],
        "data_flow": [
          {
            "source": "failed_component",
            "target": "orchestrator",
            "data": "error signal",
            "protocol": "exit_code"
          },
          {
            "source": "orchestrator",
            "target": "filesystem",
            "data": "crash log",
            "protocol": "filesystem_write"
          },
          {
            "source": "orchestrator",
            "target": "telemetry",
            "data": "error status",
            "protocol": "json_write"
          },
          {
            "source": "telemetry",
            "target": "dashboard",
            "data": "error notification",
            "protocol": "websocket"
          }
        ],
        "error_handling": [
          {
            "component": "orchestrator",
            "error": "spawner_failure",
            "recovery": "log and halt immediately"
          },
          {
            "component": "filesystem",
            "error": "log_write_fail",
            "recovery": "output to stderr"
          },
          {
            "component": "telemetry",
            "error": "broadcast_fail",
            "recovery": "continue recovery without dashboard update"
          },
          {
            "component": "orchestrator",
            "error": "state_corruption",
            "recovery": "trigger crisis mode"
          }
        ]
      }
    ],
    "integrations": [
      {
        "id": "INT-001",
        "name": "Claude Code CLI Integration",
        "type": "ai_runtime",
        "description": "Primary AI agent execution environment for Manager and Worker processes",
        "version": "latest",
        "purpose": "Provides Claude AI reasoning capabilities for code generation and analysis",
        "configuration": {
          "command": "claude-code",
          "authentication": "pre-configured via CLI login",
          "context_window": 200000,
          "model": "claude-3-opus or claude-3.5-sonnet"
        },
        "flows_using": [
          "FLOW-001",
          "FLOW-002",
          "FLOW-003",
          "FLOW-006",
          "SFLOW-001",
          "SFLOW-002",
          "SFLOW-003"
        ],
        "data_exchanged": [
          "prompts",
          "code_changes",
          "reasoning_output"
        ],
        "error_handling": "Process restart on crash, context rotation at 60%"
      },
      {
        "id": "INT-002",
        "name": "Node.js Runtime",
        "type": "runtime",
        "description": "Server runtime for Watcher service and WebSocket bridge",
        "version": ">=18.0.0 LTS",
        "purpose": "Hosts Express.js server and Socket.io for real-time dashboard updates",
        "configuration": {
          "port": 3000,
          "file_watchers": [
            "fs.watch",
            "fs.watchFile"
          ],
          "event_loop": "libuv"
        },
        "flows_using": [
          "FLOW-012",
          "FLOW-013",
          "SFLOW-005",
          "SFLOW-007"
        ],
        "data_exchanged": [
          "telemetry_json",
          "roadmap_progress",
          "crisis_signals"
        ],
        "error_handling": "Graceful shutdown, automatic restart via process manager"
      },
      {
        "id": "INT-003",
        "name": "Socket.io WebSocket Library",
        "type": "communication",
        "description": "Real-time bidirectional communication between Watcher and Dashboard",
        "version": "^4.6.0",
        "purpose": "Push telemetry and progress updates to browser clients in real-time",
        "configuration": {
          "transport": [
            "websocket",
            "polling"
          ],
          "reconnection": true,
          "reconnection_delay": 1000
        },
        "flows_using": [
          "FLOW-012",
          "FLOW-013",
          "FLOW-014",
          "SFLOW-005",
          "SFLOW-006"
        ],
        "data_exchanged": [
          "telemetry_events",
          "roadmap_events",
          "crisis_events"
        ],
        "error_handling": "Auto-reconnect with exponential backoff"
      },
      {
        "id": "INT-004",
        "name": "Express.js Web Framework",
        "type": "web_server",
        "description": "HTTP server for static file serving and API endpoints",
        "version": "^4.18.0",
        "purpose": "Serve HTML dashboard and handle Crisis Mode API",
        "configuration": {
          "static_path": "/public",
          "port": 3000
        },
        "flows_using": [
          "FLOW-012",
          "FLOW-013",
          "SFLOW-005"
        ],
        "data_exchanged": [
          "html",
          "css",
          "javascript",
          "api_requests"
        ],
        "error_handling": "Standard Express error middleware"
      },
      {
        "id": "INT-005",
        "name": "TypeScript Compiler (tsc)",
        "type": "build_tool",
        "description": "Static type checking and compilation for back pressure enforcement",
        "version": "^5.0.0",
        "purpose": "Verify type safety before code commit as guardrail check",
        "configuration": {
          "config_file": "tsconfig.json",
          "strict_mode": true
        },
        "flows_using": [
          "FLOW-008",
          "SFLOW-004"
        ],
        "data_exchanged": [
          "source_files",
          "compiler_output",
          "error_logs"
        ],
        "error_handling": "Block commit on error, capture output to LAST_COMPILER_ERROR.log"
      },
      {
        "id": "INT-006",
        "name": "Vitest/Jest Test Runner",
        "type": "testing",
        "description": "Unit test framework for code verification",
        "version": "latest",
        "purpose": "Execute test suites as part of Ralph Wiggum Loop",
        "configuration": {
          "coverage_threshold_services": 90,
          "coverage_threshold_controllers": 80
        },
        "flows_using": [
          "FLOW-008",
          "SFLOW-004"
        ],
        "data_exchanged": [
          "test_files",
          "test_results",
          "coverage_reports"
        ],
        "error_handling": "Block commit on test failure, capture output for Worker analysis"
      },
      {
        "id": "INT-007",
        "name": "Git Version Control",
        "type": "version_control",
        "description": "Code versioning and history management",
        "version": "latest",
        "purpose": "Track changes, enable Crisis Mode revert, preserve history for ADR",
        "configuration": {
          "hooks": "pre-commit for guardrails",
          "reset_strategy": "hard HEAD on crisis"
        },
        "flows_using": [
          "FLOW-006",
          "FLOW-014",
          "SFLOW-004",
          "SFLOW-006"
        ],
        "data_exchanged": [
          "commits",
          "diffs",
          "history"
        ],
        "error_handling": "Preserve history on all operations, clean working directory on crisis"
      },
      {
        "id": "INT-008",
        "name": "RipGrep (rg)",
        "type": "search_tool",
        "description": "Fast regex-based code search for pattern analysis and auditing",
        "version": "latest",
        "purpose": "Distiller pattern analysis, KreativReason standards enforcement, PIN navigation",
        "configuration": {
          "min_searches_distiller": 15,
          "search_paths": [
            "src/",
            "specs/",
            ".agent/"
          ]
        },
        "flows_using": [
          "FLOW-001",
          "FLOW-008",
          "FLOW-018",
          "SFLOW-002"
        ],
        "data_exchanged": [
          "search_queries",
          "match_results",
          "file_locations"
        ],
        "error_handling": "Continue with available results on partial failure"
      },
      {
        "id": "INT-009",
        "name": "Prisma ORM",
        "type": "database",
        "description": "Database ORM with multi-tenancy enforcement",
        "version": "^5.0.0",
        "purpose": "Database operations with mandatory tenantId for all queries",
        "configuration": {
          "tenant_id_required": true,
          "schema_path": "prisma/schema.prisma"
        },
        "flows_using": [
          "FLOW-008",
          "FLOW-018"
        ],
        "data_exchanged": [
          "database_queries",
          "schema_definitions"
        ],
        "error_handling": "Block deploy if tenantId missing in any query"
      },
      {
        "id": "INT-010",
        "name": "Zod Schema Validation",
        "type": "validation",
        "description": "Runtime schema validation for API inputs",
        "version": "^3.22.0",
        "purpose": "Validate all API endpoint inputs as guardrail requirement",
        "configuration": {
          "strict_mode": true,
          "error_messages": "detailed"
        },
        "flows_using": [
          "FLOW-008",
          "FLOW-018"
        ],
        "data_exchanged": [
          "schemas",
          "validation_results"
        ],
        "error_handling": "Return 400 on validation failure, log for audit"
      },
      {
        "id": "INT-011",
        "name": "Filesystem API",
        "type": "storage",
        "description": "Node.js filesystem for state persistence",
        "version": "native",
        "purpose": "Read/write markdown state files, telemetry, and logs",
        "configuration": {
          "state_directory": ".agent/",
          "telemetry_path": ".ralph/telemetry.json",
          "watch_method": "fs.watch"
        },
        "flows_using": [
          "FLOW-011",
          "SFLOW-005",
          "SFLOW-007"
        ],
        "data_exchanged": [
          "markdown_files",
          "json_files",
          "log_files"
        ],
        "error_handling": "Retry on EBUSY, create directories on ENOENT"
      },
      {
        "id": "INT-012",
        "name": "Process Management (Bash)",
        "type": "orchestration",
        "description": "Bash scripts for process lifecycle management",
        "version": "bash 4+",
        "purpose": "orchestrate.sh manages Manager/Worker spawning and rotation",
        "configuration": {
          "exit_code_complete": 0,
          "exit_code_rotate": 10,
          "max_retries": 3,
          "retry_delay_seconds": 5
        },
        "flows_using": [
          "FLOW-009",
          "FLOW-010",
          "FLOW-014",
          "SFLOW-001",
          "SFLOW-003"
        ],
        "data_exchanged": [
          "exit_codes",
          "process_ids",
          "environment_variables"
        ],
        "error_handling": "pkill on crisis, retry with delay on crash"
      }
    ],
    "assumptions": [
      {
        "id": "ASM-001",
        "category": "environment",
        "assumption": "Claude Code CLI is pre-authenticated and ready for headless execution",
        "rationale": "Workers and Managers spawn as separate Claude Code processes without interactive login",
        "impact_if_false": "Pipeline cannot start; requires manual authentication setup",
        "validation_method": "Run 'claude-code --version' and verify response",
        "flows_affected": [
          "FLOW-002",
          "FLOW-006",
          "SFLOW-001"
        ]
      },
      {
        "id": "ASM-002",
        "category": "environment",
        "assumption": "Users have bash-compatible shell environment (macOS/Linux)",
        "rationale": "orchestrate.sh and process management rely on bash syntax and commands",
        "impact_if_false": "Windows users require WSL or alternative orchestration",
        "validation_method": "Check $SHELL variable or run 'bash --version'",
        "flows_affected": [
          "FLOW-009",
          "FLOW-010",
          "FLOW-014",
          "SFLOW-001"
        ]
      },
      {
        "id": "ASM-003",
        "category": "environment",
        "assumption": "Node.js 18+ LTS and npm are installed on the development machine",
        "rationale": "Watcher service requires modern Node.js features and npm for dependencies",
        "impact_if_false": "Dashboard and WebSocket bridge will not function",
        "validation_method": "Run 'node --version' and verify >= 18.0.0",
        "flows_affected": [
          "FLOW-012",
          "FLOW-013",
          "SFLOW-005"
        ]
      },
      {
        "id": "ASM-004",
        "category": "environment",
        "assumption": "Git repository is initialized with proper .gitignore",
        "rationale": "Crisis Mode relies on git reset; file tracking essential for ADR",
        "impact_if_false": "Crisis revert may fail; sensitive files may be committed",
        "validation_method": "Check for .git directory and .gitignore file",
        "flows_affected": [
          "FLOW-014",
          "SFLOW-006"
        ]
      },
      {
        "id": "ASM-005",
        "category": "ai_model",
        "assumption": "Context window size is approximately 200,000 tokens",
        "rationale": "60% threshold calculations based on 200K context window",
        "impact_if_false": "Rotation thresholds need recalibration for different models",
        "validation_method": "Check Claude model documentation for context limits",
        "flows_affected": [
          "FLOW-002",
          "FLOW-005",
          "SFLOW-001"
        ]
      },
      {
        "id": "ASM-006",
        "category": "connectivity",
        "assumption": "Internet connectivity available for AI API calls",
        "rationale": "Claude Code requires API access for AI reasoning",
        "impact_if_false": "Pipeline halts; no offline mode available",
        "validation_method": "Ping anthropic.com or run test API call",
        "flows_affected": [
          "ALL"
        ]
      },
      {
        "id": "ASM-007",
        "category": "project_structure",
        "assumption": "KreativReason documentation guides are available in /docs folder",
        "rationale": "Distiller references guides for task breakdown; Workers need pattern guidance",
        "impact_if_false": "Task breakdown may be suboptimal; Workers lack context",
        "validation_method": "Verify existence of /docs directory with guide files",
        "flows_affected": [
          "FLOW-001",
          "SFLOW-002"
        ]
      },
      {
        "id": "ASM-008",
        "category": "architecture",
        "assumption": "Workers must be stateless - no memory retention between tasks",
        "rationale": "Core architectural principle; prevents context rot and cognitive debt",
        "impact_if_false": "System loses primary value proposition; context rot occurs",
        "validation_method": "Verify Worker processes fully terminate between tasks",
        "flows_affected": [
          "FLOW-006",
          "FLOW-007",
          "SFLOW-003"
        ]
      },
      {
        "id": "ASM-009",
        "category": "architecture",
        "assumption": "Manager must rotate at 60% context threshold",
        "rationale": "Prevents entry into Dumb Zone where reasoning quality degrades",
        "impact_if_false": "Hallucination and errors increase beyond 60% context fill",
        "validation_method": "Monitor telemetry and verify rotation triggers",
        "flows_affected": [
          "FLOW-002",
          "FLOW-005",
          "SFLOW-001"
        ]
      },
      {
        "id": "ASM-010",
        "category": "quality",
        "assumption": "All code must pass LLVM/compiler and unit tests before commit",
        "rationale": "Back pressure ensures code quality; guardrails prevent regressions",
        "impact_if_false": "Bad code enters codebase; technical debt accumulates",
        "validation_method": "Pre-commit hooks verify compiler and test pass",
        "flows_affected": [
          "FLOW-008",
          "SFLOW-004"
        ]
      },
      {
        "id": "ASM-011",
        "category": "task_design",
        "assumption": "Tasks must be atomic enough to complete in <40% context window",
        "rationale": "Workers need room for Ralph Loop iterations within Smart Zone",
        "impact_if_false": "Workers enter Dumb Zone mid-task; quality degrades",
        "validation_method": "Monitor Worker context fill during task execution",
        "flows_affected": [
          "FLOW-001",
          "FLOW-003",
          "FLOW-006"
        ]
      },
      {
        "id": "ASM-012",
        "category": "standards",
        "assumption": "No export default - only named exports per KreativReason standards",
        "rationale": "Consistency and explicit imports for maintainability",
        "impact_if_false": "Code style inconsistency; potential import issues",
        "validation_method": "RipGrep audit for 'export default' patterns",
        "flows_affected": [
          "FLOW-008",
          "FLOW-018"
        ]
      },
      {
        "id": "ASM-013",
        "category": "standards",
        "assumption": "Every Prisma query must include tenantId for multi-tenancy",
        "rationale": "Data isolation required for multi-tenant SaaS applications",
        "impact_if_false": "Data leaks between tenants; security vulnerability",
        "validation_method": "RipGrep audit for Prisma queries without tenantId",
        "flows_affected": [
          "FLOW-008",
          "FLOW-018"
        ]
      },
      {
        "id": "ASM-014",
        "category": "operation",
        "assumption": "System operates autonomously but requires human for Crisis intervention",
        "rationale": "Human oversight needed for emergency situations and course correction",
        "impact_if_false": "Runaway processes; uncontrolled token burn; bad commits",
        "validation_method": "Dashboard accessible and Crisis button functional",
        "flows_affected": [
          "FLOW-014",
          "SFLOW-006"
        ]
      },
      {
        "id": "ASM-015",
        "category": "performance",
        "assumption": "Worker task completion within 15-30 minute window",
        "rationale": "Tasks designed as atomic units; longer tasks indicate poor decomposition",
        "impact_if_false": "Context overflow; task needs splitting",
        "validation_method": "Monitor task completion times in telemetry",
        "flows_affected": [
          "FLOW-006",
          "SFLOW-004"
        ]
      },
      {
        "id": "ASM-016",
        "category": "performance",
        "assumption": "Telemetry latency under 100ms from file change to UI update",
        "rationale": "Real-time feedback essential for human monitoring",
        "impact_if_false": "Dashboard appears laggy; human reaction time impacted",
        "validation_method": "Measure timestamp delta between write and render",
        "flows_affected": [
          "FLOW-013",
          "SFLOW-005",
          "SFLOW-007"
        ]
      },
      {
        "id": "ASM-017",
        "category": "performance",
        "assumption": "Crisis response time under 2 seconds from button click",
        "rationale": "Emergency stop must be immediate to prevent further damage",
        "impact_if_false": "Additional bad commits or token burn during delay",
        "validation_method": "Time from click event to process termination",
        "flows_affected": [
          "FLOW-014",
          "SFLOW-006"
        ]
      },
      {
        "id": "ASM-018",
        "category": "cost",
        "assumption": "Cost target of $10.42/hour for autonomous operation",
        "rationale": "ROI calculation based on this operational cost",
        "impact_if_false": "Budget overruns; cost tracking inaccurate",
        "validation_method": "Compare actual API costs with projected rate",
        "flows_affected": [
          "FLOW-012"
        ]
      }
    ]
  }
}